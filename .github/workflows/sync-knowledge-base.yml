name: Sync n8n Knowledge Base

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-knowledge-base
  cancel-in-progress: true

jobs:
  sync-all-sources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout self
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è n8n
      - name: Sync n8n Official Docs
        uses: actions/checkout@v4
        with:
          repository: n8n-io/n8n-docs
          path: ./temp/official-docs

      # 2. –ö—Ä—É–ø–Ω–µ–π—à–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è workflow (2000+)
      - name: Sync Zie619 Workflows
        uses: actions/checkout@v4
        with:
          repository: Zie619/n8n-workflows
          path: ./temp/zie619-workflows

      # 3. AI-—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–º–ø–ª–µ–π—Ç—ã (200+)
      - name: Sync WassupJay Templates
        uses: actions/checkout@v4
        with:
          repository: wassupjay/n8n-free-templates
          path: ./temp/wassupjay-templates

      # 4. LLM-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
      - name: Sync Awesome n8n
        uses: actions/checkout@v4
        with:
          repository: Synaptiv-AI/awesome-n8n
          path: ./temp/awesome-n8n

      # 5. –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ workflow
      - name: Sync ProfSynapse Automations
        uses: actions/checkout@v4
        with:
          repository: ProfSynapse/n8n-automations
          path: ./temp/profsynapse

      # 6. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
      - name: Update Knowledge Base
        run: |
          set -e
          mkdir -p docs examples community llm-docs

          # –ö–æ–ø–∏—Ä—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
          if [ -d "./temp/official-docs/docs" ]; then
            cp -r ./temp/official-docs/docs/* ./docs/ 2>/dev/null || true
          fi

          # –ö–æ–ø–∏—Ä—É–µ–º workflow –∫–æ–ª–ª–µ–∫—Ü–∏–∏
          if [ -d "./temp/zie619-workflows" ]; then
            find ./temp/zie619-workflows -name "*.json" -exec cp {} ./examples/ \; 2>/dev/null || true
          fi

          if [ -d "./temp/wassupjay-templates" ]; then
            find ./temp/wassupjay-templates -name "*.json" -exec cp {} ./examples/ \; 2>/dev/null || true
          fi

          if [ -d "./temp/profsynapse" ]; then
            find ./temp/profsynapse -name "*.json" -exec cp {} ./examples/ \; 2>/dev/null || true
          fi

          # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è LLM
          if [ -f "./temp/awesome-n8n/n8n-docs-llms.txt" ]; then
            cp ./temp/awesome-n8n/n8n-docs-llms.txt ./llm-docs/
          fi

          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -rf ./temp

          # –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
          echo "Last updated: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > ./LAST_SYNC.md
          echo "Total workflow files: $(find ./examples -name "*.json" | wc -l)" >> ./LAST_SYNC.md

      # 7. –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ Auto-sync: n8n knowledge base updated $(date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "No changes to commit."
