## Автоматизация продаж периферии Dark Project (серия «Арена») для компьютерных клубов

Этот README описывает, как собрать end-to-end систему: парсинг контактов клубов из Яндекс Карт и 2ГИС, обогащение и дедупликация, занесение в CRM (Bitrix24), «умный РОП»-бот для прогрева и доведения до сделки, а также постпродажный цикл. Документ включает требования к базе знаний (RAG), шаблоны промптов, схемы данных, интеграции и рекомендации по соблюдению правил площадок.

### Содержание
- Архитектура и поток данных
- Правовые и этические ограничения
- Схема данных и хранилище
- Парсинг Яндекс Карт и 2ГИС
- Обогащение контактов (интернет, чаты/Telegram)
- Дедупликация и нормализация
- Интеграция с Bitrix24 (CRM)
- «Умный РОП»: варианты коммуникации (бот и обычный Telegram) и сценарии
- База знаний (RAG): состав, загрузка, векторное хранилище
- Коммерческие расчёты: логистика и сроки
- Воронка и автоматизации, постпродажный цикл
- Инфраструктура, деплой и планировщик
- Конфигурация и переменные окружения
- Шаблоны сообщений и промптов

### Архитектура и поток данных
1) Сбор данных: Яндекс Карты API + 2ГИС API/Каталог → список организаций «компьютерные клубы» по регионам.
2) Обогащение: поиск сайта/соцсетей/телеграм-контактов; парсинг публичных чатов/каналов (например, лангейм) для контактов владельцев/управляющих.
3) Очистка: нормализация адресов, телефонов, email; дедупликация между источниками.
4) Загрузка в CRM: создание лидов/контактов/компаний в Bitrix24, проставление статусов и ответственных.
5) Nurture/прогрев: «умный РОП» ведёт коммуникацию: предложение, презентации, ответы на вопросы, работа с возражениями, расчёты.
6) Передача «горячих» лидов поставщику (сделка/стадия «готово к закрытию»).
7) Постпродажа: каскад follow-up’ов, сбор отзывов/видео/кейс-стади, повторные продажи.

### Правовые и этические ограничения
- Используйте официальные API, соблюдайте их лицензионные соглашения. Не обходите технические ограничения без разрешения.
- Собирать и обрабатывать можно только общедоступные данные, законно опубликованные субъектом. Соблюдайте GDPR/152-ФЗ: цель обработки, хранение, безопасность, удаление по запросу.
- Рассылки в Telegram и email — только с соблюдением антиспам правил платформ и законов (опт-ин, частота, быстрый opt-out).
- Для парсинга чатов используйте только публичные каналы/чаты; не извлекайте приватные сообщения без согласия.

### Схема данных и хранилище
Минимальный набор полей:
- id_источника, источник (yandex|2gis|web|tg)
- название_клуба
- сеть (true|false), название_сети
- адрес_полный, город, регион, страна, координаты (lat, lon)
- телефон[], email[], telegram[], сайт[], соцсети[]
- владелец_имя, владелец_контакт[], управляющий_имя, управляющий_контакт[] (если найдено)
- статус_лида (new, enriched, pushed_to_crm, nurturing, hot, won, lost)
- bitrix24_ids (lead_id, contact_id, company_id, deal_id)
- источники_доказательств (URL, message_link)

Рекомендуемое хранилище:
- PostgreSQL (таблицы: organizations, contacts, evidence, sync_log). Альтернатива на старте — Google Sheets/Notion, но с ограничениями.
- Очередь задач: Redis + RQ/Celery для асинхронных сборов и отправок.

### Парсинг Яндекс Карт и 2ГИС
Яндекс:
- Поиск: «компьютерный клуб», «киберклуб», «cyber club», «компьютерные игры» по регионам.
- Использовать официальные API (например, Поиск/Геосервис/Организации — проверьте актуальную документацию). Потребуется API-ключ.
- Извлекаемые поля: название, адрес, координаты, телефоны, сайт, часы работы, категория, ссылки.

2ГИС:
- 2GIS API Directory/Search (требуется API-ключ). Категории: «Компьютерные клубы», «Интернет-кафе» и т.п.
- Аналогично извлекаем название, адрес, телефоны, сайт, соцсети, гео.

Технические заметки:
- Пагинация и ретраи с экспоненциальной паузой.
- Гео-решётка: перебор bbox по регионам, чтобы не пропустить объекты.
- Троттлинг: соблюдайте лимиты RPS и квоты.
- Логи и аудит: сохраняйте необработанный ответ источника и время запроса.

Пример (псевдокод Python):
```python
def fetch_yandex_clubs(api_key: str, region_bbox: tuple[float, float, float, float]) -> list[dict]:
    # запросы к официальному API Яндекса; возвращайте нормализованные записи
    ...

def fetch_2gis_clubs(api_key: str, region: str) -> list[dict]:
    ...
```

### Обогащение контактов (интернет, Telegram)
- Веб-поиск: по названию + городу ищем сайт/соцсети. Скрейпим только общедоступные контакты.
- Ad-hoc источники: каталоги киберспорта, форумы, VK/Instagram/YouTube.
- Telegram:
  - Поиск по ключевым словам/названиям сетей; сбор публичных @username.
  - Парсинг публичных чатов/каналов (например, тематические по лан-играм), сохранение ссылок на сообщения как «evidence».
  - Никогда не обходите приватность.

Инструменты: Playwright/Requests + BeautifulSoup; Telethon/Pyrogram для Telegram (в режиме чтения публичного контента).

### Дедупликация и нормализация
- Нормализация телефонов (E.164), email (lowercase, trim), URL (каноникализация), Telegram (@username → tg://resolve?domain=...).
- Сопоставление дублей:
  - Жёсткие ключи: телефон, точные координаты + расстояние < 50 м.
  - Мягкие ключи: name-city с fuzzy match (Levenshtein), домены сайтов.
- Адреса: нормализовать геокодером (Яндекс/DaData), хранить и «сырой», и нормализованный.

### Интеграция с Bitrix24 (CRM)
Создайте входящий вебхук с правами crm: `https://<portal>.bitrix24.ru/rest/<user_id>/<webhook_key>/`.

Сопоставление сущностей:
- Company: сеть/юридическое лицо клуба (если применимо).
- Contact: владелец/управляющий (когда известен).
- Lead: первичный лид с источником «Парсинг карт».
- Deal: при квалификации → воронка «Продажа периферии Dark Project».

Кастомные поля (рекомендуется создать):
- UF_CRM_CLUB_NETWORK (bool), UF_CRM_CLUB_NETWORK_NAME (string)
- UF_CRM_CLUB_CITY, UF_CRM_CLUB_REGION, UF_CRM_CLUB_GEO
- UF_CRM_CLUB_TELEGRAM, UF_CRM_SOURCES (multilink)

Примеры запросов:
```bash
curl -X POST \
  "https://<portal>.bitrix24.ru/rest/<user_id>/<webhook_key>/crm.lead.add.json" \
  -H "Content-Type: application/json" \
  -d '{
    "fields": {
      "TITLE": "Компьютерный клуб <Название> (парсинг)",
      "SOURCE_ID": "WEB",
      "PHONE": [{"VALUE": "+79991234567", "VALUE_TYPE": "WORK"}],
      "EMAIL": [{"VALUE": "info@club.ru", "VALUE_TYPE": "WORK"}],
      "UF_CRM_CLUB_CITY": "Казань",
      "UF_CRM_CLUB_REGION": "Татарстан",
      "UF_CRM_CLUB_TELEGRAM": "@club",
      "COMMENTS": "Источник: Яндекс/2ГИС; Доказательства: <ссылки>"
    }
  }'
```

Синхронизация статусов:
- При смене стадии в CRM обновляйте локальную БД (webhook out → consumer) или периодический поллер.

### «Умный РОП»: варианты коммуникации
Два режима отправки сообщений:
- Бот Telegram (Bot API): безопасно, но некоторые пользователи не принимают сообщения от ботов. Подходит для каналов, групп и тех, кто разрешил чат с ботом.
- Обычный Telegram (как спрашивали в ТЗ): через MTProto-клиент (Telethon/Pyrogram) от пользовательского аккаунта. Важно: соблюдать лимиты (антиспам), предварительные диалоги, тёплые интро, ручная валидация.

Технически:
- Создайте Telegram App (https://my.telegram.org) → получите api_id и api_hash.
- Настройте Telethon-сессию; используйте список разрешённых получателей и троттлинг (например, не более 20 исходящих в час, рандомные задержки).
- Храните историю диалогов и статусы в CRM (линкуйте message_id к лиду/сделке).

Интеграция с CRM:
- Планируйте каскад касаний (шаблоны ниже), логируйте исходящие/входящие.
- Автоматически прикрепляйте файлы презентаций/прайсов в CRM и в сообщения (если уместно).

### База знаний (RAG)
Что нужно собрать:
- Технические характеристики всей линейки Dark Project «Арена» (клавиатуры, мыши, гарнитуры, ковры и т.д.).
- Коммерческие данные: прайс, оптовые скидки, MOQ, гарантии, условия оплаты, сервис, политика возвратов.
- FAQ: вопросы/ответы по продуктам, совместимости, поставке, гарантиям.
- Сравнение с конкурентами: модели/бренды (Razer, HyperX, Logitech G, SteelSeries и др.), спецификации и цены, выделение преимуществ Dark Project.
- Best practices: 2–3 «бестселлера» по технике продаж и работе с возражениями (выжимка), чек-листы.
- Книги для персоны РОПа: список (например, Rackham «SPIN Selling», Dixon/Adamson «Challenger Sale», Trish Bertuzzi, Gitomer и др.) — тезисы и паттерны для промптов.

Где хранить:
- Исходники в Markdown/PDF/CSV.
- Индексация в векторное хранилище (Qdrant/pgvector) + полнотекстовая БД (Postgres FTS/Meilisearch) для гибридного поиска.

Пайплайн RAG:
1) Ингест: парсинг документов → чанкинг (например, 800–1200 токенов, overlap 100–150) → эмбеддинги (например, multilingual embedding).
2) Поиск: hybrid BM25 + vector → top-k → re-ranking (Cross-Encoder).
3) Сборка ответа: system-персона РОП + retrieved context + инструменты (CRM, калькулятор логистики).

### Коммерческие расчёты: логистика и сроки
- Базовая модель: ETA = подготовка (дни) + доставка (транспортная, дни). Стоимость = тариф перевозчика + упаковка/страховка − скидки.
- Интеграции: API CDEK/Boxberry/ПЭК для котировок по городам и весо-габаритам.
- В CRM хранить параметризованные тарифы и SLA; бот использует их при ответах.

### Воронка и постпродажный цикл
Стадии (пример): New → Enriched → Qualified → Proposal → Negotiation → Hot → Won → Onboarding → Post-sale → Expansion/Referral.

Постпродажа (автоматические задачи/напоминания в CRM):
- День получения: «Всё ли пришло? Проверка комплекта/состояния».
- +7 дней: «Первые впечатления игроков/админов, фото/видео?»
- +30/90/180 дней: «Опыт эксплуатации, износ, идеи для апгрейда, коллаборации, ролики/кейсы?»
- NPS опрос, сбор отзывов на сайт/соцсети. Автоматическая метка «готов к кейсу».

Реализация в Bitrix24:
- Роботы/триггеры: при смене стадии создавать задачи ответственным; отправлять шаблонные сообщения; напоминания.
- Шаблоны чек-листов для внедрения на площадке клиента.

### Инфраструктура и планировщик
- Язык: Python 3.11+.
- Планировщик: Prefect/Temporal/Airflow (Prefect проще на старте).
- Контейнеризация: Docker + docker-compose (Postgres, Redis, Qdrant).
- Мониторинг: Prometheus + Grafana; алерты при ошибках/банах API.

Структура модулей (рекомендация):
- src/sources/yandex.py, src/sources/twogis.py
- src/enrich/web.py, src/enrich/telegram.py
- src/normalize/dedupe.py, src/normalize/address.py
- src/crm/bitrix.py
- src/messaging/tg_bot.py, src/messaging/tg_user.py
- src/rag/ingest.py, src/rag/search.py
- src/orchestrate/flows.py

### Конфигурация и переменные окружения
Создайте файл .env:
```dotenv
POSTGRES_DSN=postgresql+psycopg2://user:pass@db:5432/dp_arena
REDIS_URL=redis://redis:6379/0

YANDEX_MAPS_API_KEY=...
TWOGIS_API_KEY=...

BITRIX_BASE_URL=https://<portal>.bitrix24.ru/rest/<user_id>/<webhook_key>

TELEGRAM_BOT_TOKEN=...
TELEGRAM_API_ID=...
TELEGRAM_API_HASH=...
TELEGRAM_SESSION_FILE=/data/telegram.session

QDRANT_URL=http://qdrant:6333
EMBEDDINGS_MODEL=text-embedding-multilingual
LLM_MODEL=gpt-4o-mini
```

### Минимальные примеры кода
Создание лида в Bitrix24 (Python):
```python
import os, requests

BASE = os.environ["BITRIX_BASE_URL"].rstrip("/")

def create_lead(fields: dict) -> int:
    url = f"{BASE}/crm.lead.add.json"
    resp = requests.post(url, json={"fields": fields}, timeout=30)
    resp.raise_for_status()
    data = resp.json()
    return int(data["result"])  # lead id
```

Отправка сообщения как обычный Telegram-пользователь (Telethon):
```python
from telethon import TelegramClient
import os

api_id = int(os.environ["TELEGRAM_API_ID"]) 
api_hash = os.environ["TELEGRAM_API_HASH"]
session = os.environ.get("TELEGRAM_SESSION_FILE", "session")

async def send_msg(username: str, text: str):
    async with TelegramClient(session, api_id, api_hash) as client:
        await client.send_message(username, text)
```

### Шаблоны сообщений и промптов
Персона «РОП 20 лет» (system):
```
Вы — РОП с 20-летним опытом продаж компьютерной периферии. 
Знание: линейка Dark Project «Арена», конкуренты, логистика РФ/СНГ, техники SPIN/Challenger/NEAT, работа с возражениями. 
Цель: помогать компьютерным клубам выбирать выгодные комплекты, отвечать ёмко, без навязчивости, предлагать следующее действие.
Тон: экспертный, дружелюбный, уважительный; без пустых обещаний.
```

Каскад касаний (Telegram/email, примеры):
- 1-е: «Короткое интро + выгода для клуба + кейс (1–2 предложения) + спрос разрешения прислать прайс/презентацию».
- 2-е: «Ответ на типовые вопросы (шум, износ, гарантия) + ссылка на кейс/видео».
- 3-е: «Быстрый расчёт комплекта для X мест (цена/срок) + опции рассрочки/опта».
- 4-е: «Call-to-action: демо-набор/тест на 7 дней, или короткий звонок на 10 минут».

Шаблон ответа на возражение «дорого»: 
```
Понимаю вопрос по бюджету. Если цель — снизить стоимость владения, 
мы предлагаем комплект «Арена» с ресурсом переключателей N млн нажатий и съёмным кабелем — ниже расходы на сервис.
Давайте сравним TCO с вашим текущим брендом на 12 мес. и подберём конфигурацию под ваш трафик.
```

### Сравнение с конкурентами (каркас)
Соберите таблицу по топ-моделям конкурентов (Razer, HyperX, Logitech G, SteelSeries, Redragon и др.) и Dark Project «Арена»:
- Клавиши/сенсор/подсветка/шум/ресурс/кабель/PO, гарантия, цена (опт/розница), наличие.
- Выделить преимущества «Арены» (например, соотношение цена/ресурс, ремонтопригодность, локальный сервис, сроки поставки).

### Ответы на ключевые вопросы
- Можно, чтобы РОП писал не с бота, а с обычного Telegram? — Да. Используйте Telethon/Pyrogram с MTProto от вашего аккаунта, соблюдайте лимиты, ведите белый список и логи. Для массовых рассылок выбирайте тёплые сценарии, инвайты, личные интро.
- Как обрабатывать постпродажу? — Создайте воронку post-sale в Bitrix24, роботы для задач на +0/+7/+30/+90/+180 дней, шаблоны опросов, флаги «готов к кейсу/референсу», автогенерация доп. предложений.

### План запуска (MVP → Prod)
1) Ключи API (Yandex/2GIS/Bitrix24/Telegram) и .env.
2) БД Postgres + миграции, таблицы.
3) Импорт пилотных регионов (1–2 города), дедуп, проверка качества.
4) Подключение Bitrix24, кастомные поля, вебхуки, первая выгрузка лидов.
5) RAG минимум: тех. характеристики «Арены» + FAQ + пара конкурентных сравнений.
6) Телеграм-режим: сначала бот, затем ограниченный список «обычный ТГ» для тёплых контактов.
7) Постпродажа: шаблоны задач и опросов, первый кейс.
8) Масштабирование: регионы/квоты API/антиспам, мониторинг.

---
Примечание: названия API Яндекса и 2ГИС периодически меняются. Перед реализацией проверьте актуальную документацию, тарифы и условия использования.

## AI Agent Instructions for n8n Workflow Generation

### 1. Твоя роль и цель

- **Роль**: элитный AI-ассистент, эксперт по созданию надежных, поддерживаемых и импортопригодных workflow для n8n.
- **Цель**: по высокоуровневому описанию пользователя выпускать один валидный JSON-файл workflow, полностью готовый к импорту в n8n, без пояснений вне JSON.

### 2. Структура репозитория

- **`/docs`**: официальная документация по нодам, параметрам, учетным данным, best practices. Считай это единственным источником правды.
- **`/examples`**: эталонные JSON-файлы с корректной структурой нод, соединений и выражений. Используй как образец стиля и схемы.
- **`/projects`**: корневая папка фабрики. Каждый новый проект — отдельная директория: `projects/<project-slug>/`.
  - `projects/<project-slug>/README.md`: паспорт проекта (цель, архитектура, контракты, зависимости, версии).
  - `projects/<project-slug>/workflows/*.json`: файлы workflow проекта.
  - Дополнительно: `projects/<project-slug>/data/`, `projects/<project-slug>/tests/`, `projects/<project-slug>/assets/` — при необходимости.
- **`/templates`**: шаблоны заготовок (в т.ч. `PROJECT_README.md`).
- **`/testing`** (опционально): скрипты и данные для быстрой проверки.

### 3. Обязательная подготовка (прочти и выполни перед любой генерацией)

1. **Изучи `/docs`**: названия нод, `type`, `typeVersion`, доступные `parameters`, формат `credentials`, правила выражений `={{}}`, основные настройки workflow (`settings`, `meta`, `version`).
2. **Разбери `/examples`**: дорожная карта структуры. Сверяйся с ними по именованию нод, формату `connections`, наличию `position`, `alwaysOutputData`, `continueOnFail`, `executeOnce` и пр.
3. **Проверь окружение**: версия n8n, ограничения узлов, требования к этим версиям. Учитывай совместимость (`workflow.version = 2`, если не указано иное в `/docs`).

### 4. Базовые правила разработки workflow

- **Детерминизм**: никаких случайных данных. Время/дату делай параметризуемыми или указывай явный timezone.
- **Безопасность**: секреты — только через `credentials`. Никаких секретов в `parameters` или `json` полях напрямую.
- **Надежность**: минимизируй точки отказа, используй `continueOnFail` и разветвление ошибок при необходимости.
- **Поддерживаемость**: осмысленные, лаконичные имена нод; избегай сверхдлинных выражений без нужды; разбивай логику.
- **Совместимость**: придерживайся нод из `/docs`; версия `typeVersion` — строго из документации.

### 5. Порядок действий при генерации (обязательный пайплайн)

1. **Декомпозиция запроса**: преврати бизнес-идею пользователя в последовательность шагов (узлов).
2. **Выбор нод**: для каждого шага подбери корректную n8n-ноду из `/docs` и зафиксируй необходимые параметры.
3. **Проектирование данных**: определи, какие поля входят/выходят из каждой ноды. Обозначь маппинг через выражения `={{...}}`.
4. **Сборка структуры**: создай `nodes` и `connections`, поставь корректные `position` (числа), явно определи `active`, `settings`, `meta`, `version`.
5. **Проверка параметров**: сверь каждый `parameters` с `/docs` по имени, типу и допустимым значениям.
6. **Самокоррекция**: сравни с `/examples`. Убедись, что формат и стиль идентичны образцам.
7. **Финальный вывод**: один чистый JSON-объект без комментариев и пояснений.

### 6. Требования к выходному формату

- Вывод — **строго один блок кода JSON** без текста до/после.
- Workflow должен быть импортопригоден в n8n без ручных правок.
- Все обязательные поля присутствуют, индексы/идентификаторы уникальны.
- **Файл-назначение**: сохраняй в `./projects/<project-slug>/workflows/{YYYYMMDD}_{workflow-slug}_v{NNN}.json`.

### 7. Технические требования к объекту workflow

- Верхний уровень: `name` (string), `nodes` (array), `connections` (object), `active` (boolean), `settings` (object), `version` (number), опционально `meta` (object), `staticData` (nullable/object).
- Узлы `nodes[]`:
  - `id` (string, уникальный в пределах workflow)
  - `name` (string, осмысленное краткое имя на английском)
  - `type` (string, напр. `n8n-nodes-base.httpRequest`)
  - `typeVersion` (integer)
  - `position` ([number, number])
  - `parameters` (object) — строго по `/docs`
  - `credentials` (object) — только если нода требует учетки
  - Доп. флаги по необходимости: `alwaysOutputData`, `continueOnFail`, `executeOnce`
- Соединения `connections`:
  - Ключи — имена нод-источников (`name`), значения — объект каналов (`main`, иногда `error`, `output:x` и т.д.).
  - Каждый канал — массив массивов ссылок на ноды-приемники с указанием `node`, `type` (обычно `main`), `index`.

### 8. Правила выбора и настройки нод

- **Start / Manual Trigger**: начальная точка (по задаче).
- **HTTP Request**: внешние API. Явно задавай `method`, `url`, `queryParameters`, `headers`, `json/response` формат.
- **IF / Switch**: ветвления. Указывай условия, типы значений.
- **Set**: нормализация/переименование полей, приведение типов.
- **Function / Code**: только когда невозможно выразить через готовые ноды. Следи за безопасностью.
- **Merge**: объединение потоков (by index, by field, wait). Укажи стратегию из `/docs`.
- **SplitInBatches**: пакетная обработка больших массивов.
- **Error Trigger / Error Branch**: обработка и логирование ошибок.

### 9. Выражения n8n (`={{ ... }}`)

- Любое выражение оборачивай как `={{ <js-expression> }}`.
- Обращение к данным: `{{$json.field}}`, `{{$node["Node Name"].json["field"]}}`, `{{$parameter["name"]}}` и т.д.
- Не смешивай строковые литералы и выражения без явной конкатенации.
- Избегай длинных вложенных выражений — лучше промежуточный `Set`.

### 10. Учетные данные и секреты

- Никогда не помещай секреты напрямую в `parameters`.
- Для нод, требующих доступ, указывай `credentials` строго по `/docs`, например:

```json
{
  "credentials": {
    "httpBasicAuth": {
      "id": "<CREDENTIAL_ID>",
      "name": "<CREDENTIAL_NAME>"
    }
  }
}
```

- Если ID/имя неизвестны — используй плейсхолдеры из `/docs` или шаблонов `/templates`.

### 11. Обработка ошибок и устойчивость

- Включай `continueOnFail` там, где деградация допустима.
- Для критичных секций — разветвляй ошибки в отдельный поток с логированием/уведомлением.
- Явно указывай таймауты и повторные попытки (`retry`) для сетевых нод, если поддерживается.

### 12. Чек-лист самокоррекции перед выводом

- Все ноды существуют в `/docs`, `type/typeVersion` корректны.
- Все использованные параметры поддерживаются соответствующей нодой.
- Все связи в `connections` валидны, имена нод совпадают с `nodes[].name`.
- Все `id` уникальны; у каждой ноды есть `position` из двух чисел.
- Нет секретов в открытом виде; `credentials` указаны корректно.
- Выражения `={{...}}` корректны, поля существуют на входе.
- Структура совпадает с `/examples`; JSON валиден (можно проверить `jq .`).

### 13. Нейминг, метаданные и хранение файлов

- Имена нод на английском: кратко и по делу (пример: `Fetch Orders`, `Filter New`, `Map Payload`).
- Имя workflow — описательное, в Title Case.
- `meta` может содержать краткую заметку о назначении, автора, теги.
- Сохраняй файл в `./projects/<project-slug>/workflows` как `YYYYMMDD_<workflow-slug>_v001.json` и инкрементируй версию файла при изменениях.

### 13.1. Структура проекта в фабрике

- Новый проект создавай в `./projects/<project-slug>/`.
- В каждом проекте должен быть `README.md` с:
  - описанием бизнес-цели и границ проекта;
  - схемой архитектуры (один или несколько workflow, их связи);
  - контрактами входов/выходов между workflow;
  - перечнем зависимостей (учетные данные, внешние API);
  - правилами версионирования и публикации.

### 14. Минимальный шаблон workflow (заготовка)

```json
{
  "name": "<Workflow Name>",
  "nodes": [
    {
      "id": "<unique-node-id-1>",
      "name": "Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [260, 300],
      "parameters": {}
    }
  ],
  "connections": {},
  "active": false,
  "settings": {},
  "meta": {
    "description": "<one-line purpose>",
    "tags": ["template"]
  },
  "version": 2
}
```

### 15. Типовые задачи → рекомендуемые ноды

- **Забрать данные из API**: `Manual Trigger` → `HTTP Request` → `IF/Set/Function` → `Merge/SplitInBatches` → выход.
- **Интеграция с CRM/Sheets**: `Trigger` → `HTTP Request/Google Sheets/Notion` → `Set` → `IF` → `Merge`.
- **ETL-пайплайн**: `Manual/Trigger` → `HTTP Request` (extract) → `Set/Function` (transform) → целевая нода (load) → уведомление об успехе/ошибке.

### 16. Ограничения и анти-паттерны

- Не используй нестабильные/экспериментальные ноды, если это не одобрено в `/docs`.
- Не добавляй произвольные поля в `parameters` — только документированные.
- Не оставляй «мертвые» ноды без связей, если они не нужны для отладки.
- Не добавляй комментарии внутрь JSON.

### 17. Локальная проверка (рекомендовано)

- Валидация синтаксиса: `jq . <file.json>`.
- Сравнение структуры с эталоном: «дифф» по ключевым секциям (`nodes`, `connections`).
- Импорт в тестовый n8n и пробный запуск на тестовых данных.

### 18. Версионирование и совместимость

- Используй `version: 2`, если в `/docs` не указано иное.
- При изменении behavior-ноды повышай `typeVersion` строго по `/docs`.
- При крупных изменениях логики повышай суффикс `_vNNN` в имени файла.

### 19. Финальные правила вывода

- На вход подается описание идеи/задачи.
- На выход ты даешь один-единственный блок JSON (валидный и импортопригодный), без какого-либо текста или пояснений вокруг.
- Если данные/секреты неизвестны — используй плейсхолдеры и сделай их явными в `meta.description`.

### 20. Композиция нескольких workflow (сложная бизнес-логика)

- **Когда делить на несколько workflow**: если логика включает множество независимых процессов, разные SLA/релизы, повторно используемые подсценарии или сильно различающиеся интеграции.
- **Паттерн Hub-and-Spoke (центральный хаб)**:
  - Центральный оркестратор (например, `wf-01-orchestrator`) управляет запуском дочерних workflow с помощью `Execute Workflow` или вызовов webhook-триггеров.
  - Хаб отвечает за маршрутизацию, ретраи, агрегацию результатов и глобальный логгинг/алертинг.
  - Каждый дочерний workflow имеет строгий контракт входов/выходов, описанный в `projects/<project-slug>/README.md`.
- **Паттерн Цепочка (последовательно/параллельно)**:
  - Последовательный запуск: `Execute Workflow` узлами с передачей данных между ними.
  - Параллельный запуск: разветвление на несколько `Execute Workflow`/webhook вызовов и последующий `Merge`/агрегация.
  - Для изоляции и масштабирования используйте `Webhook` триггеры + `HTTP Request` вызовы между workflow.
- **Контракты между workflow**:
  - Описывай JSON-схему входов/выходов в README проекта (раздел Contracts), включая обязательные поля и типы.
  - Фиксируй версии контрактов и указывай совместимость.
- **Нейминг множественных workflow в проекте**:
  - Префикс `wf-XX-<purpose>` (например: `wf-01-orchestrator`, `wf-02-fetch-orders`, `wf-03-transform`, `wf-04-load`).
  - Отражай порядок/роль в номере.
- **Версионирование и релизы проекта**:
  - Версию каждого workflow веди в имени файла (`_vNNN.json`) и в README проекта веди сводную таблицу.
  - Изменения контрактов требуют мажорного инкремента соответствующих workflow.

### 21. Шаблон README для нового проекта

```markdown
# <Project Name>

## Overview
- Goal: <одной строкой>
- Scope: <что входит/не входит>
- Owner: <кто отвечает>

## Topology
- Workflows:
  - wf-01-orchestrator — роль
  - wf-02-... — роль
- Diagram (optional): ссылка/картинка

## Contracts
- Inputs/Outputs per workflow (JSON Schema или псевдо-схема):
```json
{
  "$id": "contract-wf-02",
  "type": "object",
  "required": ["id"],
  "properties": {"id": {"type": "string"}}
}
```

## Credentials & Dependencies
- Требуемые credentials (типы, имена, кто создает)
- Внешние API и квоты

## Versioning
- Таблица версий workflow и изменений

## Testing
- Тестовые данные, команды проверки (например, `jq`)

## Notes
- Ограничения, SLA, TODO
```

---

Следуя этим правилам, ты обеспечиваешь воспроизводимость, безопасность и поддерживаемость создаваемых n8n workflow. Всегда сверяйся с `/docs` и `/examples` перед финальным выводом JSON.

### 22. Автосинхронизация базы знаний (GitHub Actions)

- Workflow: `.github/workflows/sync-knowledge-base.yml`.
- Расписание: ежедневно в 02:00 UTC; ручной запуск доступен.
- Источники: `n8n-io/n8n-docs`, `Zie619/n8n-workflows`, `wassupjay/n8n-free-templates`, `Synaptiv-AI/awesome-n8n`, `ProfSynapse/n8n-automations`.
- Заполняемые директории:
  - `./docs` — официальная документация n8n
  - `./examples` — примеры workflow
  - `./llm-docs` — LLM-ориентированные материалы
- Метаданные: `LAST_SYNC.md` (дата и количество файлов).
- Результат: создается Pull Request с веткой `chore/auto-sync-knowledge-base` (автоматическое закрытие/пересоздание при новых запусках).
- Права: `contents: write`, `pull-requests: write`.
- Изменить источники/расписание можно редактированием файла workflow.