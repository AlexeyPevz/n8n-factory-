# üîç –û—Ç—á–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ WF-04 Sales Nurture Agent

## –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: ‚ö†Ô∏è **–¢—Ä–µ–±—É—é—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

---

## ‚úÖ –ß—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º:

### 1. **–í–µ—Ä—Å–∏–∏ —É–∑–ª–æ–≤**
- ‚úÖ –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —É–∑–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
- ‚úÖ AI Agent –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –≤–µ—Ä—Å–∏–∏ 2.2
- ‚úÖ HTTP Request —É–∑–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–µ—Ä—Å–∏—é 4.1

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- ‚úÖ –ï—Å—Ç—å Error Trigger –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚úÖ –û—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Redis –¥–ª—è –∞—É–¥–∏—Ç–∞
- ‚úÖ –í Function —É–∑–ª–∞—Ö –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### 3. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ `$env.VARIABLE_NAME`
- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

### 4. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow**
- ‚úÖ –õ–æ–≥–∏—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Merge —É–∑–ª–æ–≤ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

### 1. **–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –≤–µ—Ä—Å–∏–∏ —É–∑–ª–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —É–∑–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏, —á—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- `httpRequest` v4 –∏ v4.1 –≤ –æ–¥–Ω–æ–º workflow
- `splitInBatches` v3 (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å –¥—Ä—É–≥–∏–º–∏ —É–∑–ª–∞–º–∏)

**–†–µ—à–µ–Ω–∏–µ**:
```json
// –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ HTTP Request –¥–æ v4.1
"typeVersion": 4.1

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å splitInBatches v3
```

### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timeout –≤ HTTP –∑–∞–ø—Ä–æ—Å–∞—Ö**

**–ü—Ä–æ–±–ª–µ–º–∞**: HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ Bitrix24 –∏ MTProto –Ω–µ –∏–º–µ—é—Ç timeout

**–†–µ—à–µ–Ω–∏–µ**:
```json
"options": {
  "timeout": 30000,  // 30 —Å–µ–∫—É–Ω–¥
  "retry": {
    "maxTries": 3,
    "waitBetweenTries": 2000
  }
}
```

### 3. **–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í workflow –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ .env.example:
- ‚ùå `TELEGRAM_ADMIN_CHAT_ID` (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö)
- ‚ùå `REDIS_*` –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –≤ .env.example:
```bash
# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Telegram Admin
TELEGRAM_ADMIN_CHAT_ID=-1001234567890
```

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**–ü—Ä–æ–±–ª–µ–º–∞**: Webhook —É–∑–ª—ã –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å Function —É–∑–µ–ª –ø–æ—Å–ª–µ webhooks:
```javascript
// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
if (!$json.leadId && !$json.message) {
  throw new Error('Invalid webhook payload');
}
return $items;
```

### 5. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**

**–ü—Ä–æ–±–ª–µ–º–∞**: Function —É–∑–ª—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø–æ–ª–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤–º–µ—Å—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// –í–º–µ—Å—Ç–æ
return [{ json: response.result }];

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
return [{
  json: {
    id: response.result.ID,
    title: response.result.TITLE,
    // —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
  }
}];
```

### 6. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å Function —É–∑–µ–ª –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
```javascript
const log = {
  timestamp: new Date().toISOString(),
  workflow: 'WF-04',
  action: 'process_lead',
  leadId: $json.leadId,
  status: 'success'
};

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```

### 7. **Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –∫–æ–¥–µ:
- –†–∞–±–æ—á–∏–µ —á–∞—Å—ã (9-17)
- TTL –¥–ª—è Redis (86400)
- –õ–∏–º–∏—Ç—ã –∏ —Ç–∞–π–º–∞—É—Ç—ã

**–†–µ—à–µ–Ω–∏–µ**: –í—ã–Ω–µ—Å—Ç–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ staticData

### 8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –∫–æ–¥–µ**

**–ü—Ä–æ–±–ª–µ–º–∞**: Function —É–∑–ª—ã –∏–º–µ—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:
```javascript
/**
 * –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç Bitrix24 API
 * @param {Object} response - –û—Ç–≤–µ—Ç –æ—Ç API
 * @returns {Array} –ú–∞—Å—Å–∏–≤ –ª–∏–¥–æ–≤
 */
```

---

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### 1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É credentials**
```javascript
// –í –Ω–∞—á–∞–ª–µ workflow
if (!$env.BITRIX24_WEBHOOK_URL) {
  throw new Error('BITRIX24_WEBHOOK_URL not configured');
}
```

### 2. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ AI Agent**
```json
{
  "onError": "continueErrorOutput",
  "continueOnFail": true
}
```

### 3. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –ú–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –°—á–µ—Ç—á–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ AI

---

## üìä –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Best Practices:

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚ö†Ô∏è | –°–º–µ—à–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —É–∑–ª–æ–≤ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | ‚úÖ | –ï—Å—Ç—å Error Trigger |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | ‚ö†Ô∏è | –ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚ö†Ô∏è | –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ webhook |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚ùå | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | ‚ùå | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å | ‚ö†Ô∏è | –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:

1. **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**:
   - –î–æ–±–∞–≤–∏—Ç—å timeout –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏–∏ —É–∑–ª–æ–≤

2. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**:
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
   - –í—ã–Ω–µ—Å—Ç–∏ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**:
   - –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
   - –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Function —É–∑–ª–æ–≤

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Sub-workflows** –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–π—Å—è –ª–æ–≥–∏–∫–∏
2. **–î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ CRM
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å circuit breaker** –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
4. **–î–æ–±–∞–≤–∏—Ç—å health checks** –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

---

## ‚úÖ –ò—Ç–æ–≥:

Workflow –≤ —Ü–µ–ª–æ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ –¥–ª—è production-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º.