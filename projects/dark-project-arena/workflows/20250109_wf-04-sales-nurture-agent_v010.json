{
  "name": "WF-04 Sales Nurture with AI Agent",
  "nodes": [
    {
      "id": "bitrix24-new-leads-trigger-001",
      "name": "Bitrix24 New Leads Schedule",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [260, 200],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "*/30 9-17 * * 1-5"
            }
          ]
        }
      }
    },
    {
      "id": "mtproto-message-trigger-001",
      "name": "MTProto Message Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "mtproto-incoming",
        "authentication": "headerAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "MTPROTO_WEBHOOK_SECRET",
          "name": "MTProto Webhook Secret"
        }
      }
    },
    {
      "id": "bitrix24-webhook-001",
      "name": "Bitrix24 Lead Update",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 400],
      "parameters": {
        "httpMethod": "POST",
        "path": "bitrix24-lead-nurture",
        "authentication": "headerAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "BITRIX24_WEBHOOK_SECRET",
          "name": "Bitrix24 Webhook Secret"
        }
      }
    },
    {
      "id": "manual-trigger-001",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [260, 500],
      "parameters": {}
    },
    {
      "id": "merge-triggers-001",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [460, 400],
      "parameters": {
        "mode": "chooseBranch",
        "options": {}
      }
    },
    {
      "id": "identify-source-001",
      "name": "Identify Message Source",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [660, 400],
      "parameters": {
        "functionCode": "// Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ°\nlet messageData = {};\n\n// Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…\nif (!$json || Object.keys($json).length === 0) {\n  throw new Error('Empty webhook payload received');\n}\n\n// Telegram ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\nif ($json.message) {\n  const msg = $json.message;\n  \n  // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Telegram Ð´Ð°Ð½Ð½Ñ‹Ñ…\n  if (!msg.chat || !msg.chat.id) {\n    throw new Error('Invalid Telegram message: missing chat.id');\n  }\n  if (!msg.from || !msg.from.id) {\n    throw new Error('Invalid Telegram message: missing from.id');\n  }\n  \n  messageData = {\n    source: 'telegram',\n    chatId: msg.chat.id,\n    userId: msg.from.id,\n    userName: msg.from.first_name || 'ÐšÐ»Ð¸ÐµÐ½Ñ‚',\n    text: msg.text || '',\n    messageId: msg.message_id,\n    isReply: true\n  };\n}\n// Bitrix24 webhook (Ð½Ð¾Ð²Ñ‹Ð¹ Ð»Ð¸Ð´ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ)\nelse if ($json.leadId || $json.LEAD_ID) {\n  const leadId = $json.leadId || $json.LEAD_ID;\n  \n  // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Bitrix24 Ð´Ð°Ð½Ð½Ñ‹Ñ…\n  if (!leadId || leadId.toString().trim() === '') {\n    throw new Error('Invalid Bitrix24 webhook: empty leadId');\n  }\n  \n  messageData = {\n    source: 'bitrix24',\n    leadId: leadId,\n    status: $json.STATUS_ID || 'NEW',\n    phone: $json.PHONE || '',\n    isReply: false,\n    needsInitialContact: true\n  };\n}\n// Manual trigger Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ\nelse if ($execution.mode === 'manual') {\n  messageData = {\n    source: 'manual',\n    leadId: $json.leadId || '12345',\n    isReply: false,\n    needsInitialContact: true\n  };\n}\n// ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº\nelse {\n  throw new Error('Unknown webhook source. Expected: message (Telegram) or leadId (Bitrix24)');\n}\n\n// Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ\nif (messageData.source === 'telegram' && !messageData.text && !messageData.messageId) {\n  throw new Error('Telegram message without text or messageId');\n}\n\nconsole.log('Message source identified:', messageData.source);\n\nreturn [{ json: messageData }];"
      }
    },
    {
      "id": "get-lead-context-001",
      "name": "Get Lead Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [860, 400],
      "parameters": {
        "functionCode": "const messageData = $json;\nlet leadContext = {};\n\n// Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°, Ð½Ð°Ð¹Ð´ÐµÐ¼ Ð»Ð¸Ð´ Ð¿Ð¾ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ/telegram\nif (messageData.isReply && messageData.source === 'telegram') {\n  // Ð—Ð´ÐµÑÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº Ð² CRM Ð¿Ð¾ telegram userId\n  // Ð”Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ\n  leadContext = {\n    needsSearch: true,\n    searchBy: 'telegram',\n    searchValue: messageData.userId\n  };\n} \n// Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð° Ð¸Ð· CRM\nelse if (messageData.leadId) {\n  leadContext = {\n    needsLoad: true,\n    leadId: messageData.leadId\n  };\n}\n\nreturn [{ \n  json: {\n    ...messageData,\n    leadContext\n  } \n}];"
      }
    },
    {
      "id": "load-lead-from-crm-001",
      "name": "Load Lead from CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1060, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.get",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.leadId || $json.leadContext.leadId }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "parse-load-lead-001",
      "name": "Parse Load Lead Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1160, 300],
      "parameters": {
        "functionCode": "// Parse Bitrix24 HTTP response for single lead\nconst response = $json;\n\nif (response && response.result) {\n  // Single lead returned as object\n  return [{ json: response.result }];\n} else if (response && response.error) {\n  console.error('Bitrix24 error:', response.error);\n  return [];\n} else {\n  console.error('Invalid Bitrix24 response');\n  return [];\n}"
      }
    },
    {
      "id": "search-lead-by-telegram-001",
      "name": "Search Lead by Telegram",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1060, 500],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.list",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "filter[UF_CRM_TELEGRAM_ID]",
              "value": "={{ $json.userId }}"
            },
            {
              "name": "select[]",
              "value": "ID"
            },
            {
              "name": "select[]",
              "value": "TITLE"
            },
            {
              "name": "select[]",
              "value": "STATUS_ID"
            },
            {
              "name": "select[]",
              "value": "PHONE"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_TELEGRAM"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_DIALOG_HISTORY"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "router-lead-search-001",
      "name": "Route Lead Search",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needsLoad",
              "leftValue": "={{ $json.leadContext.needsLoad }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "merge-lead-data-001",
      "name": "Merge Lead Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1260, 400],
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      }
    },
    {
      "id": "parse-search-telegram-001",
      "name": "Parse Search by Telegram Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1160, 500],
      "parameters": {
        "functionCode": "// Parse Bitrix24 HTTP response for lead list\nconst response = $json;\n\nif (response && response.result && Array.isArray(response.result)) {\n  if (response.result.length > 0) {\n    // Return first lead found\n    return [{ json: response.result[0] }];\n  } else {\n    // No leads found\n    return [];\n  }\n} else if (response && response.error) {\n  console.error('Bitrix24 error:', response.error);\n  return [];\n} else {\n  console.error('Invalid Bitrix24 response');\n  return [];\n}"
      }
    },
    {
      "id": "prepare-agent-context-001",
      "name": "Prepare Agent Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1460, 400],
      "parameters": {
        "functionCode": "// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ AI Agent\nconst messageData = $node['Identify Message Source'].json;\nconst leadData = $json;\n\n// ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°\nlet dialogHistory = [];\ntry {\n  if (leadData.UF_CRM_DIALOG_HISTORY) {\n    dialogHistory = JSON.parse(leadData.UF_CRM_DIALOG_HISTORY);\n  }\n} catch (e) {\n  dialogHistory = [];\n}\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°\nconst agentContext = {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð»Ð¸Ð´Ð°\n  leadId: leadData.ID || leadData.id,\n  clubName: leadData.TITLE || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑƒÐ±',\n  city: leadData.ADDRESS_CITY || '',\n  phone: leadData.PHONE || '',\n  telegram: leadData.UF_CRM_TELEGRAM || '',\n  status: leadData.STATUS_ID || 'NEW',\n  \n  // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n  isChain: leadData.UF_CRM_IS_CHAIN === 'Y',\n  branchCount: parseInt(leadData.UF_CRM_BRANCH_COUNT) || 1,\n  estimatedPCs: parseInt(leadData.UF_CRM_ESTIMATED_PCS) || 20,\n  priority: leadData.UF_CRM_PRIORITY || 'medium',\n  \n  // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n  dialogHistory: dialogHistory,\n  contactCount: dialogHistory.length,\n  lastContactDate: dialogHistory.length > 0 ? dialogHistory[dialogHistory.length - 1].date : null,\n  \n  // Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\n  currentMessage: messageData.text || '',\n  isIncoming: messageData.isReply,\n  messageSource: messageData.source,\n  \n  // Ð¤Ð»Ð°Ð³Ð¸ Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°\n  needsInitialContact: messageData.needsInitialContact || false,\n  shouldClassifyIntent: messageData.isReply\n};\n\nconsole.log(`Agent context prepared for ${agentContext.clubName}`);\n\nreturn [{ json: agentContext }];"
      }
    },
    {
      "id": "qdrant-vector-store-001",
      "name": "Qdrant Knowledge Base",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "typeVersion": 1,
      "position": [1660, 300],
      "parameters": {
        "qdrantCollection": "dark_project_kb"
      },
      "credentials": {
        "qdrantApi": {
          "id": "QDRANT_API",
          "name": "Qdrant API"
        }
      }
    },
    {
      "id": "vector-store-tool-001",
      "name": "KB Search Tool",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [1860, 300],
      "parameters": {
        "name": "search_knowledge_base",
        "description": "ÐŸÐ¾Ð¸ÑÐº Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ†Ð¸Ð¸ Dark Project, Ñ†ÐµÐ½Ð°Ñ…, ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ… ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð°, Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ°Ñ…"
      }
    },
    {
      "id": "crm-update-tool-001",
      "name": "CRM Update Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1,
      "position": [1860, 400],
      "parameters": {
        "name": "update_crm",
        "description": "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð² CRM: ÑÑ‚Ð°Ñ‚ÑƒÑ Ð»Ð¸Ð´Ð°, ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸, Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°",
        "workflowId": "={{ $env.WF_03_WORKFLOW_ID }}",
        "fields": {
          "values": [
            {
              "name": "leadId",
              "type": "string",
              "description": "ID Ð»Ð¸Ð´Ð° Ð² CRM"
            },
            {
              "name": "action",
              "type": "string", 
              "description": "Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: update_status, add_comment, update_dialog_history"
            },
            {
              "name": "data",
              "type": "json",
              "description": "Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ"
            }
          ]
        }
      }
    },
    {
      "id": "calculator-tool-001",
      "name": "Discount Calculator",
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [1860, 500],
      "parameters": {
        "name": "calculate_discount",
        "description": "ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° ÑÐºÐ¸Ð´Ð¾Ðº Ð¸ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ñ… ÑÑƒÐ¼Ð¼ Ð·Ð°ÐºÐ°Ð·Ð°"
      }
    },
    {
      "id": "conversation-memory-001",
      "name": "Conversation Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1,
      "position": [1860, 600],
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.leadId }}",
        "contextWindowLength": 10
      }
    },
    {
      "id": "openai-chat-model-001",
      "name": "GPT-4 Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1860, 700],
      "parameters": {
        "model": "gpt-4",
        "temperature": 0.7,
        "maxTokens": 500
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      }
    },
    {
      "id": "fallback-chat-model-001",
      "name": "GPT-3.5 Fallback Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1860, 800],
      "parameters": {
        "model": "gpt-3.5-turbo",
        "temperature": 0.7,
        "maxTokens": 500
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      }
    },
    {
      "id": "sales-agent-001",
      "name": "Sales Agent Ð ÐžÐŸ 20Y",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [2060, 400],
      "parameters": {
        "agentType": "conversationalAgent",
        "prompt": "={{ $json.needsInitialContact ? 'ÐÐ°Ñ‡Ð½Ð¸ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ ' + $json.clubName + ' Ð¸Ð· ' + $json.city + '. Ð£ Ð½Ð¸Ñ… ' + $json.estimatedPCs + ' ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ð¾Ð². Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´.' : ($json.currentMessage || '') }}",
        "systemMessage": "=== Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ«Ð™ ÐŸÐ ÐžÐœÐŸÐ¢ ===\n\nÐ¢Ñ‹ â€” ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€, Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ñ‚Ð´ÐµÐ»Ð° Ð¿Ñ€Ð¾Ð´Ð°Ð¶ (Ð ÐžÐŸ) ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Dark Project Arena Ñ 20-Ð»ÐµÑ‚Ð½Ð¸Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼ Ð² Ð¸Ð½Ð´ÑƒÑÑ‚Ñ€Ð¸Ð¸ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ð½Ð¾Ð¹ Ð¿ÐµÑ€Ð¸Ñ„ÐµÑ€Ð¸Ð¸. Ð¢ÐµÐ±Ðµ 42 Ð³Ð¾Ð´Ð°, Ñ‚Ñ‹ Ð»Ð¸Ñ‡Ð½Ð¾ Ð·Ð½Ð°ÐµÑˆÑŒ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†ÐµÐ² Ð¼Ð½Ð¾Ð³Ð¸Ñ… ÐºÑ€ÑƒÐ¿Ð½Ñ‹Ñ… ÐºÐ¸Ð±ÐµÑ€ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ð²Ð½Ñ‹Ñ… ÐºÐ»ÑƒÐ±Ð¾Ð².\n\n=== Ð¢Ð’ÐžÐ¯ Ð›Ð˜Ð§ÐÐžÐ¡Ð¢Ð¬ ===\n- ÐžÐ±Ñ‰Ð°ÐµÑˆÑŒÑÑ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾, Ð½Ð° Â«Ñ‚Ñ‹Â», Ð½Ð¾ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾\n- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑˆÑŒ ÑÐ¼Ð¾Ð´Ð·Ð¸, Ð½Ð¾ Ð² Ð¼ÐµÑ€Ñƒ (1-2 Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ)\n- ÐŸÐ¸ÑˆÐµÑˆÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ, ÐµÐ¼ÐºÐ¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ð´Ð¾ 400 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)\n- Ð’ÑÐµÐ³Ð´Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚ÐµÐ½ Ð¸ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ÑˆÑŒ Ð¾ Ð²Ñ‹Ð³Ð¾Ð´Ð°Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°\n- Ð—Ð½Ð°ÐµÑˆÑŒ Ð±Ð¾Ð»Ð¸ ÐºÐ»ÑƒÐ±Ð¾Ð²: Ð¿Ð¾Ð»Ð¾Ð¼ÐºÐ¸ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ, Ð¶Ð°Ð»Ð¾Ð±Ñ‹ Ð³ÐµÐ¹Ð¼ÐµÑ€Ð¾Ð², Ð²Ñ‹ÑÐ¾ÐºÐ¸Ðµ Ð·Ð°Ñ‚Ñ€Ð°Ñ‚Ñ‹\n\n=== ÐœÐ•Ð¢ÐžÐ”ÐžÐ›ÐžÐ“Ð˜Ð¯ ÐŸÐ ÐžÐ”ÐÐ– ===\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑˆÑŒ SPIN-selling:\n1. Situation - Ð²Ñ‹ÑÑÐ½Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ\n2. Problem - Ð½Ð°Ð¹Ð´Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°\n3. Implication - Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´ÑÑ‚Ð²Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼\n4. Need-payoff - Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ\n\n=== ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢ Ð”Ð˜ÐÐ›ÐžÐ“Ð ===\nÐ¢Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑˆÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÐºÐ»ÑƒÐ±Ðµ Ð² JSON:\n- clubName - Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ»ÑƒÐ±Ð°\n- city - Ð³Ð¾Ñ€Ð¾Ð´\n- estimatedPCs - ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ð¾Ð²\n- isChain - ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ ÑÐµÑ‚ÑŒÑŽ\n- dialogHistory - Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n- currentMessage - Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°\n- needsInitialContact - Ð½ÑƒÐ¶ÐµÐ½ Ð»Ð¸ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚\n\n=== Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð ===\n\n1. Ð•Ð¡Ð›Ð˜ needsInitialContact = true (Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚):\n   Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:\n   - ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒÑÑ (ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€ Ð¸Ð· Dark Project Arena)\n   - Ð£Ð¿Ð¾Ð¼ÑÐ½Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ»ÑƒÐ±Ð° Ð¸ Ð³Ð¾Ñ€Ð¾Ð´\n   - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ð¹ (Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°)\n   - Ð—Ð°ÐºÐ¾Ð½Ñ‡Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð¼ Ð¾Ð± Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ\n   - ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± ÑÐ²ÑÐ·Ð¸\n\n2. Ð•Ð¡Ð›Ð˜ ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (currentMessage Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ðµ):\n   - ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\n   - ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ\n   - Ð”Ð°Ð¹ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¿Ð¾ SPIN\n\n3. ÐšÐ›ÐÐ¡Ð¡Ð˜Ð¤Ð˜ÐšÐÐ¦Ð˜Ð¯ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ð¹ Ð¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:\n   - \"ÑÐ¼ÐµÐ½Ð°_ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°\" â†’ \"ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾! ÐÐ° ÐºÐ°ÐºÐ¾Ð¹ Ð½Ð¾Ð¼ÐµÑ€/Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼ ÑƒÐ´Ð¾Ð±Ð½ÐµÐµ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ?\"\n   - \"Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ_ÐµÑÑ‚ÑŒ\" â†’ Ð²Ñ‹ÑÐ²Ð»ÑÐ¹ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾ SPIN\n   - \"Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ_Ðº_Ñ†ÐµÐ½Ðµ\" â†’ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ search_knowledge_base Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ñ†ÐµÐ½\n   - \"Ñ…Ð¾Ñ‡ÐµÑ‚_Ñ‚ÐµÑÑ‚\" â†’ \"ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°ÑŽ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ñ 2-3 Ð¼Ñ‹ÑˆÐµÐº Dark Project ME3. Ð”Ð¾ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð·Ð° Ð½Ð°Ñˆ ÑÑ‡ÐµÑ‚.\"\n   - \"Ð³Ð¾Ñ‚Ð¾Ð²_Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒÑÑ\" â†’ \"Ð¡ÑƒÐ¿ÐµÑ€! ÐšÐ¾Ð³Ð´Ð° Ð²Ð°Ð¼ ÑƒÐ´Ð¾Ð±Ð½Ð¾? ÐœÐ¾Ð³Ñƒ Ð¿Ð¾Ð´ÑŠÐµÑ…Ð°Ñ‚ÑŒ Ñ Ð¾Ð±Ñ€Ð°Ð·Ñ†Ð°Ð¼Ð¸.\"\n   - \"ÐµÑÑ‚ÑŒ_Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº\" â†’ ÑƒÐ·Ð½Ð°Ð¹ ÐºÑ‚Ð¾ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ\n   - \"Ð´Ð¾Ñ€Ð¾Ð³Ð¾\" â†’ Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ñ€Ð°ÑÑ‡ÐµÑ‚ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ð·Ð° ÑÑ‡ÐµÑ‚ Ð´Ð¾Ð»Ð³Ð¾Ð²ÐµÑ‡Ð½Ð¾ÑÑ‚Ð¸\n   - \"Ð½Ðµ_Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾\" â†’ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸ ÐºÐ¾Ð³Ð´Ð° Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÑŽÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ\n   - \"Ð¾Ñ‚ÐºÐ°Ð·\" â†’ \"ÐŸÐ¾Ð½ÑÐ», ÑÐ¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° ÑƒÐ´ÐµÐ»ÐµÐ½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ! Ð•ÑÐ»Ð¸ Ñ‡Ñ‚Ð¾ - Ñ Ð½Ð° ÑÐ²ÑÐ·Ð¸.\"\n\n=== Ð’ÐÐ–ÐÐ«Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð ===\n- Ð’Ð¡Ð•Ð“Ð”Ð Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ search_knowledge_base Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ñ†ÐµÐ½ Ð¸ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸Ðº\n- ÐÐ˜ÐšÐžÐ“Ð”Ð Ð½Ðµ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ Ñ†ÐµÐ½Ñ‹, ÑƒÑÐ»Ð¾Ð²Ð¸Ñ, Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸\n- ÐŸÐ¾ÑÐ»Ðµ ÐšÐÐ–Ð”ÐžÐ“Ðž Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ update_crm Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸\n- ÐŸÑ€Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ðº Ð¿Ð¾ÐºÑƒÐ¿ÐºÐµ Ð¡Ð ÐÐ—Ð£ Ð¼ÐµÐ½ÑÐ¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð½Ð° \"Ð“Ð¾Ñ€ÑÑ‡Ð¸Ð¹\"\n- Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ Ñ€Ð°ÑÑ‡ÐµÑ‚ ÑÐºÐ¸Ð´ÐºÐ¸ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ calculate_discount\n\n=== ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐŸÐ•Ð Ð’Ð«Ð¥ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð™ ===\n\nÐ”Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð³Ð¾ ÐºÐ»ÑƒÐ±Ð° (50+ ÐŸÐš):\n\"ÐŸÑ€Ð¸Ð²ÐµÑ‚! ðŸ‘‹\nÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€, Dark Project Arena.\nÐ’Ð¸Ð¶Ñƒ Ñƒ Ð²Ð°Ñ ÑÐµÑ€ÑŒÐµÐ·Ð½Ñ‹Ð¹ ÐºÐ»ÑƒÐ± {clubName} Ð² {city} - {estimatedPCs} Ð¼Ð°ÑˆÐ¸Ð½ ÑÑ‚Ð¾ ÑÐ¾Ð»Ð¸Ð´Ð½Ð¾!\n\nÐœÐ½Ð¾Ð³Ð¸Ðµ ÐºÑ€ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ»ÑƒÐ±Ñ‹ Ð¶Ð°Ð»ÑƒÑŽÑ‚ÑÑ Ð½Ð° Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð¸Ð·Ð½Ð¾Ñ Ð¿ÐµÑ€Ð¸Ñ„ÐµÑ€Ð¸Ð¸. Ð£ Ð²Ð°Ñ ÐºÐ°Ðº Ñ ÑÑ‚Ð¸Ð¼?\nÐœÐ¾Ð¶ÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾ Ð±ÑƒÐ´ÐµÑ‚ ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ? Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ñ ÑÐµÑ‚ÑÐ¼Ð¸ Ð¿Ð¾ Ð²ÑÐµÐ¹ Ð Ð¾ÑÑÐ¸Ð¸.\"\n\nÐ”Ð»Ñ ÑÑ€ÐµÐ´Ð½ÐµÐ³Ð¾ ÐºÐ»ÑƒÐ±Ð° (20-50 ÐŸÐš):\n\"Ð”Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ! ðŸŽ®\nÐœÐµÐ½Ñ Ð·Ð¾Ð²ÑƒÑ‚ ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€, Ñ Ð¸Ð· Dark Project Arena.\nÐ—Ð°Ð¼ÐµÑ‚Ð¸Ð» Ð²Ð°Ñˆ ÐºÐ»ÑƒÐ± {clubName} Ð² {city}.\n\nÐœÑ‹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ÑÑ Ð½Ð° Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ Ð¿ÐµÑ€Ð¸Ñ„ÐµÑ€Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ð½Ñ‹Ñ… ÐºÐ»ÑƒÐ±Ð¾Ð².\nÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ Ð»Ð¸ Ð´Ð»Ñ Ð²Ð°Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼Ñ‹ÑˆÐµÐº/ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€?\nÐ˜Ð»Ð¸ ÑƒÐ´Ð¾Ð±Ð½ÐµÐµ Ð¿Ð¾Ð¾Ð±Ñ‰Ð°Ñ‚ÑŒÑÑ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ðµ?\"\n\n=== ÐŸÐžÐœÐÐ˜ ===\nÐ¢Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ñ€Ð¾Ð´Ð°Ð²ÐµÑ†, Ð° ÑÐºÑÐ¿ÐµÑ€Ñ‚ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ ÐºÐ»ÑƒÐ±Ð°Ð¼ Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð·Ð° ÑÑ‡ÐµÑ‚ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ!",
        "options": {
          "maxIterations": 10,
          "returnIntermediateSteps": false
        }
      }
    },
    {
      "id": "parse-agent-response-001",
      "name": "Parse Agent Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2260, 400],
      "parameters": {
        "functionCode": "// ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð°Ð³ÐµÐ½Ñ‚Ð°\nconst agentResponse = $json;\nconst context = $node['Prepare Agent Context'].json;\n\n// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¸ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ\nlet responseText = '';\nlet intent = 'unknown';\nlet shouldUpdateStatus = false;\nlet newStatus = context.status;\n\n// ÐŸÐ°Ñ€ÑÐ¸Ð¼ output Ð°Ð³ÐµÐ½Ñ‚Ð°\nif (typeof agentResponse === 'string') {\n  responseText = agentResponse;\n} else if (agentResponse.output) {\n  responseText = agentResponse.output;\n} else if (agentResponse.text) {\n  responseText = agentResponse.text;\n}\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ intent Ð¿Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð°Ð¼ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð°Ð³ÐµÐ½Ñ‚Ð° Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°\nconst lowerResponse = responseText.toLowerCase();\nconst currentMessage = context.currentMessage?.toLowerCase() || '';\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐ¼ÐµÐ½Ñƒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°\nif (currentMessage.match(/Ð½Ð°Ð¿Ð¸Ñˆ[Ð¸|Ð¸Ñ‚Ðµ]?\\s+Ð½Ð°|Ð»ÑƒÑ‡ÑˆÐµ\\s+Ð½Ð°|Ð¼Ð¾Ð¹\\s+(Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼|email|Ð¿Ð¾Ñ‡Ñ‚|Ð½Ð¾Ð¼ÐµÑ€|whatsapp|Ð²Ð°Ñ‚ÑÐ°Ð¿)/)) {\n  intent = 'ÑÐ¼ÐµÐ½Ð°_ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°';\n} \n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ\nelse if (currentMessage.includes('Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾') || currentMessage.includes('Ñ€Ð°ÑÑÐºÐ°Ð¶Ð¸') || currentMessage.includes('Ð´Ð°Ð²Ð°Ð¹')) {\n  intent = 'Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ_ÐµÑÑ‚ÑŒ';\n  if (context.status === 'NEW') {\n    newStatus = 'IN_PROGRESS';\n    shouldUpdateStatus = true;\n  }\n} \n// Ð’ÑÑ‚Ñ€ÐµÑ‡Ð°\nelse if (lowerResponse.includes('Ð²ÑÑ‚Ñ€ÐµÑ‡') || lowerResponse.includes('ÑÐ¾Ð·Ð²Ð¾Ð½')) {\n  intent = 'Ð³Ð¾Ñ‚Ð¾Ð²_Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒÑÑ';\n  newStatus = 'HOT';\n  shouldUpdateStatus = true;\n} \n// Ð¦ÐµÐ½Ñ‹\nelse if (lowerResponse.includes('Ñ†ÐµÐ½') || lowerResponse.includes('ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚') || lowerResponse.includes('ÑÐºÐ¸Ð´Ðº')) {\n  intent = 'Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ_Ðº_Ñ†ÐµÐ½Ðµ';\n  if (context.status === 'NEW') {\n    newStatus = 'IN_PROGRESS';\n    shouldUpdateStatus = true;\n  }\n} \n// Ð¢ÐµÑÑ‚\nelse if (lowerResponse.includes('Ñ‚ÐµÑÑ‚') || lowerResponse.includes('Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°')) {\n  intent = 'Ñ…Ð¾Ñ‡ÐµÑ‚_Ñ‚ÐµÑÑ‚';\n  newStatus = 'IN_PROGRESS';\n  shouldUpdateStatus = true;\n} \n// ÐžÑ‚ÐºÐ°Ð·\nelse if (currentMessage.includes('Ð½Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾') || currentMessage.includes('Ð½Ðµ Ð½Ð°Ð´Ð¾') || currentMessage.includes('ÑÐ¿Ð°ÑÐ¸Ð±Ð¾, Ð½ÐµÑ‚')) {\n  intent = 'Ð¾Ñ‚ÐºÐ°Ð·';\n  newStatus = 'JUNK';\n  shouldUpdateStatus = true;\n} \n// Ð•ÑÑ‚ÑŒ Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº\nelse if (currentMessage.includes('ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ') || currentMessage.includes('Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ñ') || currentMessage.includes('Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº')) {\n  intent = 'ÐµÑÑ‚ÑŒ_Ð¿Ð¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº';\n}\n// Ð”Ð¾Ñ€Ð¾Ð³Ð¾\nelse if (currentMessage.includes('Ð´Ð¾Ñ€Ð¾Ð³Ð¾') || currentMessage.includes('Ð´ÐµÑˆÐµÐ²Ð»Ðµ') || currentMessage.includes('Ð±ÑŽÐ´Ð¶ÐµÑ‚')) {\n  intent = 'Ð´Ð¾Ñ€Ð¾Ð³Ð¾';\n}\n// ÐÐµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾\nelse if (currentMessage.includes('Ð½Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾') || currentMessage.includes('Ð¿Ð¾ÐºÐ° Ð½Ðµ') || currentMessage.includes('Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð·Ð¶Ðµ')) {\n  intent = 'Ð½Ðµ_Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾';\n}\n\n// ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°\nconst newDialogEntry = {\n  date: new Date().toISOString(),\n  from: context.isIncoming ? 'client' : 'rop',\n  message: context.isIncoming ? context.currentMessage : responseText,\n  intent: intent\n};\n\nconst updatedHistory = [...context.dialogHistory, newDialogEntry];\n\nreturn [{\n  json: {\n    context: context,\n    agentResponse: responseText,\n    intent: intent,\n    shouldUpdateStatus: shouldUpdateStatus,\n    newStatus: newStatus,\n    updatedHistory: updatedHistory,\n    shouldSendMessage: !context.isIncoming || responseText.length > 0\n  }\n}];"
      }
    },
    {
      "id": "update-crm-dialog-001",
      "name": "Update CRM Dialog History",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2460, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.update",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.context.leadId }}"
            },
            {
              "name": "fields[UF_CRM_DIALOG_HISTORY]",
              "value": "={{ JSON.stringify($json.updatedHistory) }}"
            },
            {
              "name": "fields[UF_CRM_LAST_CONTACT]",
              "value": "={{ new Date().toISOString() }}"
            },
            {
              "name": "fields[UF_CRM_CONTACT_COUNT]",
              "value": "={{ $json.updatedHistory.length }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "update-lead-status-001",
      "name": "Update Lead Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2460, 500],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.update",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.context.leadId }}"
            },
            {
              "name": "fields[STATUS_ID]",
              "value": "={{ $json.newStatus }}"
            },
            {
              "name": "fields[COMMENTS]",
              "value": "={{ $json.context.COMMENTS + '\\n\\n[' + new Date().toISOString() + '] Intent: ' + $json.intent + '\\nAgent: ' + $json.agentResponse.substring(0, 200) + '...' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "route-update-status-001",
      "name": "Should Update Status?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2460, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldUpdate",
              "leftValue": "={{ $json.shouldUpdateStatus }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "merge-crm-updates-001",
      "name": "Merge CRM Updates",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [2660, 400],
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      }
    },
    {
      "id": "route-send-message-001",
      "name": "Should Send Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2860, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldSend",
              "leftValue": "={{ $node['Parse Agent Response'].json.shouldSendMessage }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "route-channel-001",
      "name": "Route by Channel",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [3060, 300],
      "parameters": {
        "dataType": "string",
        "value1": "={{ $node['Parse Agent Response'].json.context.preferredChannel || 'telegram' }}",
        "rules": {
          "rules": [
            {
              "value2": "telegram",
              "output": 0
            },
            {
              "value2": "whatsapp",
              "output": 1
            },
            {
              "value2": "email",
              "output": 2
            }
          ]
        },
        "fallbackOutput": 0
      }
    },
    {
      "id": "send-telegram-mtproto-001",
      "name": "Send via MTProto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3260, 200],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.MTPROTO_API_URL }}/send",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParametersJson": "={{ { \"chat_id\": $node['Parse Agent Response'].json.context.telegram || $node['Identify Message Source'].json.chatId, \"message\": $node['Parse Agent Response'].json.agentResponse, \"parse_mode\": \"Markdown\" } }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 3,
            "waitBetweenTries": 2000
          }
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "MTPROTO_API_AUTH",
          "name": "MTProto API Auth"
        }
      }
    },
    {
      "id": "send-whatsapp-001",
      "name": "Send WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3260, 300],
      "parameters": {
        "method": "POST",
        "url": "https://api.whatsapp.com/send",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppBusinessApi",
        "sendBody": true,
        "bodyParametersJson": "={{ { \"messaging_product\": \"whatsapp\", \"to\": $node['Parse Agent Response'].json.context.phone || $node['Parse Agent Response'].json.context.whatsapp, \"type\": \"text\", \"text\": { \"body\": $node['Parse Agent Response'].json.agentResponse } } }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 3,
            "waitBetweenTries": 2000
          }
        }
      },
      "credentials": {
        "whatsAppBusinessApi": {
          "id": "WHATSAPP_BUSINESS_API",
          "name": "WhatsApp Business API"
        }
      }
    },
    {
      "id": "send-email-001",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [3260, 400],
      "parameters": {
        "fromEmail": "alexander@darkproject.ru",
        "toEmail": "={{ $node['Parse Agent Response'].json.context.email }}",
        "subject": "Dark Project Arena - Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ {{ $node['Parse Agent Response'].json.context.clubName }}",
        "text": "={{ $node['Parse Agent Response'].json.agentResponse }}",
        "options": {}
      },
      "credentials": {
        "smtp": {
          "id": "SMTP_CREDENTIALS",
          "name": "SMTP Email"
        }
      }
    },
    {
      "id": "check-hot-lead-001",
      "name": "Check if Hot Lead",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3260, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "isHot",
              "leftValue": "={{ $node['Parse Agent Response'].json.newStatus }}",
              "rightValue": "HOT",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "trigger-hot-lead-handoff-001",
      "name": "Trigger Hot Lead Handoff",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [3460, 300],
      "parameters": {
        "source": "database",
        "workflowId": "={{ $env.WF_05_WORKFLOW_ID }}",
        "waitForSubWorkflow": false
      }
    },
    {
      "id": "complete-001",
      "name": "Complete",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [3460, 500],
      "parameters": {}
    },
    {
      "id": "error-trigger-001",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [260, 700],
      "parameters": {}
    },
    {
      "id": "handle-error-001",
      "name": "Handle Error",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 700],
      "parameters": {
        "functionCode": "const error = {\n  workflow: 'WF-04 Sales Nurture Agent',\n  timestamp: new Date().toISOString(),\n  error: $json.error?.message || 'Unknown error',\n  node: $json.error?.node?.name || 'Unknown',\n  context: $node['Prepare Agent Context']?.json || {}\n};\n\nconsole.error('WF-04 Agent Error:', error);\n\nreturn [{ json: error }];"
      }
    },
    {
      "id": "save-error-001",
      "name": "Save Error",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [660, 700],
      "parameters": {
        "operation": "lpush",
        "key": "errors:sales_nurture_agent",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": "={{ parseInt($env.REDIS_CACHE_TTL) || 86400 }}"
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      }
    },
    {
      "id": "get-new-leads-001",
      "name": "Get New Leads from CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [460, 200],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.list",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "filter[STATUS_ID]",
              "value": "NEW"
            },
            {
              "name": "filter[UF_CRM_CONTACT_COUNT]",
              "value": "0"
            },
            {
              "name": "order[UF_CRM_PRIORITY]",
              "value": "DESC"
            },
            {
              "name": "order[UF_CRM_ESTIMATED_PCS]",
              "value": "DESC"
            },
            {
              "name": "select[]",
              "value": "ID"
            },
            {
              "name": "select[]",
              "value": "TITLE"
            },
            {
              "name": "select[]",
              "value": "PHONE"
            },
            {
              "name": "select[]",
              "value": "EMAIL"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_TELEGRAM"
            },
            {
              "name": "select[]",
              "value": "ADDRESS_CITY"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_IS_CHAIN"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_ESTIMATED_PCS"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_PRIORITY"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "parse-new-leads-001",
      "name": "Parse New Leads Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [560, 200],
      "parameters": {
        "functionCode": "// Parse Bitrix24 HTTP response for lead list\nconst response = $json;\n\nif (response && response.result && Array.isArray(response.result)) {\n  // Return each lead as separate item\n  return response.result.map(lead => ({ json: lead }));\n} else if (response && response.error) {\n  console.error('Bitrix24 error:', response.error);\n  return [];\n} else {\n  console.error('Invalid Bitrix24 response');\n  return [];\n}"
      }
    },
    {
      "id": "split-new-leads-001",
      "name": "Split New Leads",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [660, 200],
      "parameters": {
        "batchSize": 1,
        "options": {}
      }
    },
    {
      "id": "rate-limit-001",
      "name": "Rate Limit Protection",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [760, 200],
      "parameters": {
        "resume": "timeInterval",
        "amount": 2,
        "unit": "seconds"
      }
    },
    {
      "id": "prepare-initial-contact-001",
      "name": "Prepare Initial Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [860, 200],
      "parameters": {
        "functionCode": "// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°\nconst lead = $json;\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð»ÑƒÑ‡ÑˆÐ¸Ð¹ ÐºÐ°Ð½Ð°Ð» ÑÐ²ÑÐ·Ð¸\nlet preferredChannel = 'none';\nlet contactValue = '';\n\nif (lead.UF_CRM_TELEGRAM) {\n  preferredChannel = 'telegram';\n  contactValue = lead.UF_CRM_TELEGRAM;\n} else if (lead.UF_CRM_WHATSAPP || (lead.PHONE && lead.PHONE.length > 0)) {\n  preferredChannel = 'whatsapp';\n  contactValue = lead.UF_CRM_WHATSAPP || lead.PHONE[0].VALUE || lead.PHONE;\n} else if (lead.EMAIL && lead.EMAIL.length > 0) {\n  preferredChannel = 'email';\n  contactValue = lead.EMAIL[0].VALUE || lead.EMAIL;\n}\n\n// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\nconst context = {\n  leadId: lead.ID,\n  clubName: lead.TITLE || 'Ð£Ð²Ð°Ð¶Ð°ÐµÐ¼Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚',\n  city: lead.ADDRESS_CITY || '',\n  isChain: lead.UF_CRM_IS_CHAIN === 'Y',\n  estimatedPCs: parseInt(lead.UF_CRM_ESTIMATED_PCS) || 20,\n  preferredChannel: preferredChannel,\n  contactValue: contactValue,\n  isInitialContact: true,\n  needsKP: true,\n  dialogHistory: [],\n  contactCount: 0\n};\n\nif (preferredChannel === 'none') {\n  console.log(`No contact info for lead ${lead.ID}`);\n  return [{ json: { skip: true, leadId: lead.ID, reason: 'No contact info' } }];\n}\n\nreturn [{ json: context }];"
      }
    },
    {
      "id": "check-skip-lead-001",
      "name": "Check Skip Lead",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldSkip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "check-working-hours-001",
      "name": "Check Working Hours",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1160, 100],
      "parameters": {
        "functionCode": "// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº\nconst now = new Date();\nconst moscowOffset = 3; // UTC+3\nconst moscowHour = (now.getUTCHours() + moscowOffset) % 24;\nconst dayOfWeek = now.getUTCDay();\n\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ\nconst workHoursStart = parseInt($env.WORK_HOURS_START) || 9;\nconst workHoursEnd = parseInt($env.WORK_HOURS_END) || 18;\nconst workDaysStart = parseInt($env.WORK_DAYS_START) || 1;\nconst workDaysEnd = parseInt($env.WORK_DAYS_END) || 5;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ\nconst isWorkingHours = \n  dayOfWeek >= workDaysStart && \n  dayOfWeek <= workDaysEnd && \n  moscowHour >= workHoursStart && \n  moscowHour < workHoursEnd;\n\nif (!isWorkingHours) {\n  console.log(`ÐÐµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ: Ð´ÐµÐ½ÑŒ ${dayOfWeek}, Ñ‡Ð°Ñ ${moscowHour} (ÐœÐ¡Ðš)`);\n  console.log(`Ð Ð°Ð±Ð¾Ñ‡Ð¸Ðµ Ñ‡Ð°ÑÑ‹: ${workHoursStart}:00 - ${workHoursEnd}:00, Ð´Ð½Ð¸: ${workDaysStart}-${workDaysEnd}`);\n  return [{ \n    json: { \n      ...($json),\n      skipReason: 'outside_working_hours',\n      shouldWait: true,\n      moscowHour: moscowHour,\n      dayOfWeek: dayOfWeek\n    } \n  }];\n}\n\nreturn [{ json: $json }];"
      }
    },
    {
      "id": "generate-initial-kp-001",
      "name": "Prepare Initial Contact Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1260, 100],
      "parameters": {
        "functionCode": "// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ\nconst context = $json;\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð° (Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ Prepare Agent Context)\nconst agentContext = {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð»Ð¸Ð´Ð°\n  leadId: context.leadId,\n  clubName: context.clubName || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑƒÐ±',\n  city: context.city || '',\n  phone: context.phone || '',\n  telegram: context.telegram || '',\n  status: 'NEW',\n  \n  // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n  isChain: context.isChain || false,\n  branchCount: 1,\n  estimatedPCs: context.estimatedPCs || 20,\n  priority: 'medium',\n  \n  // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n  dialogHistory: [],\n  contactCount: 0,\n  lastContactDate: null,\n  \n  // Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ - Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°\n  currentMessage: '',\n  isIncoming: false,\n  messageSource: 'crm_initial',\n  \n  // Ð¤Ð»Ð°Ð³Ð¸ Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°\n  needsInitialContact: true,\n  shouldClassifyIntent: false,\n  isInitialContact: true,\n  preferredChannel: context.preferredChannel,\n  contactValue: context.contactValue\n};\n\nconsole.log(`Initial contact context prepared for ${agentContext.clubName}`);\n\nreturn [{ json: agentContext }];"
      }
    },
    {
      "id": "detect-contact-change-001", 
      "name": "Detect Contact Change Request",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2060, 200],
      "parameters": {
        "functionCode": "// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚\nconst agentResponse = $json;\nconst context = $node['Prepare Agent Context'].json;\nconst currentMessage = context.currentMessage || '';\n\n// ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° ÑÐ¼ÐµÐ½Ñ‹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°\nconst patterns = [\n  /Ð½Ð°Ð¿Ð¸Ñˆ[Ð¸|Ð¸Ñ‚Ðµ]?\\s+Ð½Ð°\\s+(\\+?[0-9\\s\\-\\(\\)]+)/i,\n  /Ð»ÑƒÑ‡ÑˆÐµ\\s+Ð½Ð°\\s+(\\+?[0-9\\s\\-\\(\\)]+)/i,\n  /Ð¼Ð¾Ð¹\\s+Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼\\s*[@]?([a-zA-Z0-9_]+)/i,\n  /Ð¿Ð¸ÑˆÐ¸\\s+Ð²\\s+Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼\\s*[@]?([a-zA-Z0-9_]+)/i,\n  /Ð½Ð°\\s+Ð¿Ð¾Ñ‡Ñ‚Ñƒ\\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i,\n  /Ð¼Ð¾Ð¹\\s+email\\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i\n];\n\nlet newContactInfo = null;\nlet newContactType = null;\nlet newContactValue = null;\n\nfor (const pattern of patterns) {\n  const match = currentMessage.match(pattern);\n  if (match) {\n    newContactValue = match[1];\n    if (pattern.toString().includes('Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼')) {\n      newContactType = 'telegram';\n      newContactValue = newContactValue.startsWith('@') ? newContactValue : '@' + newContactValue;\n    } else if (pattern.toString().includes('email') || pattern.toString().includes('Ð¿Ð¾Ñ‡Ñ‚Ñƒ')) {\n      newContactType = 'email';\n    } else {\n      newContactType = 'phone';\n      newContactValue = newContactValue.replace(/[^0-9+]/g, '');\n    }\n    break;\n  }\n}\n\nif (newContactType) {\n  newContactInfo = {\n    detected: true,\n    type: newContactType,\n    value: newContactValue,\n    leadId: context.leadId\n  };\n}\n\nreturn [{\n  json: {\n    ...agentResponse,\n    newContactInfo: newContactInfo\n  }\n}];"
      }
    },
    {
      "id": "route-contact-update-001",
      "name": "Route Contact Update", 
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2260, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "hasNewContact",
              "leftValue": "={{ $json.newContactInfo?.detected }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "update-contact-in-crm-001",
      "name": "Update Contact in CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2460, 100],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.update",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.newContactInfo.leadId }}"
            },
            {
              "name": "fields",
              "value": "={{ JSON.stringify($json.newContactInfo.type === 'telegram' ? { UF_CRM_TELEGRAM: $json.newContactInfo.value, UF_CRM_PREFERRED_CHANNEL: 'telegram' } : $json.newContactInfo.type === 'email' ? { EMAIL: [{ VALUE: $json.newContactInfo.value, VALUE_TYPE: 'WORK' }], UF_CRM_PREFERRED_CHANNEL: 'email' } : { PHONE: [{ VALUE: $json.newContactInfo.value, VALUE_TYPE: 'WORK' }], UF_CRM_PREFERRED_CHANNEL: 'phone' }) }}"
            },
            {
              "name": "fields[COMMENTS]",
              "value": "={{ $json.context.COMMENTS + '\\n\\n[' + new Date().toISOString() + '] ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ð» Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚: ' + $json.newContactInfo.type + ' - ' + $json.newContactInfo.value }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "send-to-new-contact-001",
      "name": "Send to New Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2660, 100],
      "parameters": {
        "functionCode": "// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚\nconst data = $json;\nconst newContact = data.newContactInfo;\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°\nlet confirmMessage = `Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! ÐŸÑ€Ð¾Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð½Ð° ${newContact.value} ðŸ‘`;\nlet redirectMessage = data.agentResponse; // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð°Ð³ÐµÐ½Ñ‚Ð°\n\nreturn [{\n  json: {\n    ...data,\n    confirmMessage: confirmMessage,\n    redirectMessage: redirectMessage,\n    shouldSendToNewContact: true,\n    newChannel: newContact.type,\n    newContactValue: newContact.value\n  }\n}];"
      }
    }
  ],
  "connections": {
          "MTProto Message Trigger": {
        "main": [[{"node": "Merge Triggers", "type": "main", "index": 0}]]
      },
    "Bitrix24 Lead Update": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 1}]]
    },
    "Manual Trigger": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 2}]]
    },
    "Merge Triggers": {
      "main": [[{"node": "Identify Message Source", "type": "main", "index": 0}]]
    },
    "Identify Message Source": {
      "main": [[{"node": "Get Lead Context", "type": "main", "index": 0}]]
    },
    "Get Lead Context": {
      "main": [[{"node": "Route Lead Search", "type": "main", "index": 0}]]
    },
    "Route Lead Search": {
      "main": [
        [{"node": "Load Lead from CRM", "type": "main", "index": 0}],
        [{"node": "Search Lead by Telegram", "type": "main", "index": 0}]
      ]
    },
    "Load Lead from CRM": {
      "main": [[{"node": "Parse Load Lead Response", "type": "main", "index": 0}]]
    },
    "Parse Load Lead Response": {
      "main": [[{"node": "Merge Lead Data", "type": "main", "index": 0}]]
    },
    "Search Lead by Telegram": {
      "main": [[{"node": "Parse Search by Telegram Response", "type": "main", "index": 0}]]
    },
    "Parse Search by Telegram Response": {
      "main": [[{"node": "Merge Lead Data", "type": "main", "index": 1}]]
    },
    "Merge Lead Data": {
      "main": [[{"node": "Prepare Agent Context", "type": "main", "index": 0}]]
    },
    "Prepare Agent Context": {
      "main": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "main", "index": 0}]]
    },
    "Qdrant Knowledge Base": {
      "ai_vectorStore": [[{"node": "KB Search Tool", "type": "ai_vectorStore", "index": 0}]]
    },
    "KB Search Tool": {
      "ai_tool": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "ai_tool", "index": 0}]]
    },
    "CRM Update Tool": {
      "ai_tool": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "ai_tool", "index": 1}]]
    },
    "Discount Calculator": {
      "ai_tool": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "ai_tool", "index": 2}]]
    },
    "Conversation Memory": {
      "ai_memory": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "ai_memory", "index": 0}]]
    },
    "GPT-4 Chat Model": {
      "ai_languageModel": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "ai_languageModel", "index": 0}]]
    },
    "GPT-3.5 Fallback Model": {
      "ai_languageModel": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "ai_languageModel", "index": 1}]]
    },
    "Sales Agent Ð ÐžÐŸ 20Y": {
      "main": [[{"node": "Parse Agent Response", "type": "main", "index": 0}]]
    },
    "Parse Agent Response": {
      "main": [[{"node": "Detect Contact Change Request", "type": "main", "index": 0}]]
    },
    "Update CRM Dialog History": {
      "main": [[{"node": "Should Update Status?", "type": "main", "index": 0}]]
    },
    "Should Update Status?": {
      "main": [
        [{"node": "Update Lead Status", "type": "main", "index": 0}],
        [{"node": "Merge CRM Updates", "type": "main", "index": 1}]
      ]
    },
    "Update Lead Status": {
      "main": [[{"node": "Merge CRM Updates", "type": "main", "index": 0}]]
    },
    "Merge CRM Updates": {
      "main": [[{"node": "Should Send Message?", "type": "main", "index": 0}]]
    },
          "Should Send Message?": {
        "main": [
          [{"node": "Route by Channel", "type": "main", "index": 0}],
          [{"node": "Complete", "type": "main", "index": 0}]
        ]
      },
      "Route by Channel": {
        "main": [
          [{"node": "Send via MTProto", "type": "main", "index": 0}],
          [{"node": "Send WhatsApp", "type": "main", "index": 0}],
          [{"node": "Send Email", "type": "main", "index": 0}]
        ]
      },
      "Send via MTProto": {
        "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
      },
      "Send WhatsApp": {
        "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
      },
      "Send Email": {
        "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
      },
    "Check if Hot Lead": {
      "main": [
        [{"node": "Trigger Hot Lead Handoff", "type": "main", "index": 0}],
        [{"node": "Complete", "type": "main", "index": 0}]
      ]
    },
    "Error Trigger": {
      "main": [[{"node": "Handle Error", "type": "main", "index": 0}]]
    },
    "Handle Error": {
      "main": [[{"node": "Save Error", "type": "main", "index": 0}]]
    },
    "Bitrix24 New Leads Schedule": {
      "main": [[{"node": "Get New Leads from CRM", "type": "main", "index": 0}]]
    },
    "Get New Leads from CRM": {
      "main": [[{"node": "Parse New Leads Response", "type": "main", "index": 0}]]
    },
    "Parse New Leads Response": {
      "main": [[{"node": "Split New Leads", "type": "main", "index": 0}]]
    },
    "Split New Leads": {
      "main": [[{"node": "Rate Limit Protection", "type": "main", "index": 0}]]
    },
    "Rate Limit Protection": {
      "main": [[{"node": "Prepare Initial Contact", "type": "main", "index": 0}]]
    },
    "Prepare Initial Contact": {
      "main": [[{"node": "Check Skip Lead", "type": "main", "index": 0}]]
    },
          "Check Skip Lead": {
        "main": [
          [{"node": "Check Working Hours", "type": "main", "index": 0}],
          [{"node": "Complete", "type": "main", "index": 0}]
        ]
      },
      "Check Working Hours": {
        "main": [[{"node": "Generate Initial KP", "type": "main", "index": 0}]]
      },
    "Generate Initial KP": {
      "main": [[{"node": "Sales Agent Ð ÐžÐŸ 20Y", "type": "main", "index": 0}]]
    },
    "Detect Contact Change Request": {
      "main": [[{"node": "Route Contact Update", "type": "main", "index": 0}]]
    },
    "Route Contact Update": {
      "main": [
        [{"node": "Update Contact in CRM", "type": "main", "index": 0}],
        [{"node": "Update CRM Dialog History", "type": "main", "index": 0}]
      ]
    },
    "Update Contact in CRM": {
      "main": [[{"node": "Send to New Contact", "type": "main", "index": 0}]]
    },
    "Send to New Contact": {
      "main": [[{"node": "Update CRM Dialog History", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 180,
    "timezone": "Europe/Moscow"
  },
  "version": 2,
  "id": "wf-04-sales-nurture-agent",
  "meta": {
    "templateCredsSetupCompleted": true,
    "description": "AI Agent-based sales nurturing with full dialog management, intent classification, and CRM integration - Fixed prompt parameter",
    "version": "2.1.0"
  },
  "tags": [
    {
      "id": "1",
      "name": "production"
    },
    {
      "id": "6",
      "name": "ai-agent"
    },
    {
      "id": "7",
      "name": "sales"
    }
  ]
}