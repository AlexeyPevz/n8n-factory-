{
  "name": "WF-04 Sales Nurture with AI Agent",
  "nodes": [
    {
      "id": "bitrix24-new-leads-trigger-001",
      "name": "Bitrix24 New Leads Schedule",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [260, 200],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 30,
              "unit": "minutes"
            }
          ]
        }
      }
    },
    {
      "id": "telegram-message-trigger-001",
      "name": "Telegram Message Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [260, 300],
      "parameters": {
        "updates": ["message", "callback_query"]
      },
      "credentials": {
        "telegramApi": {
          "id": "TG_ROP_BOT",
          "name": "Telegram ROP Bot"
        }
      }
    },
    {
      "id": "bitrix24-webhook-001",
      "name": "Bitrix24 Lead Update",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 400],
      "parameters": {
        "httpMethod": "POST",
        "path": "bitrix24-lead-nurture",
        "authentication": "headerAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "BITRIX24_WEBHOOK_SECRET",
          "name": "Bitrix24 Webhook Secret"
        }
      }
    },
    {
      "id": "manual-trigger-001",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [260, 500],
      "parameters": {}
    },
    {
      "id": "merge-triggers-001",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [460, 400],
      "parameters": {
        "mode": "chooseBranch",
        "options": {}
      }
    },
    {
      "id": "identify-source-001",
      "name": "Identify Message Source",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [660, 400],
      "parameters": {
        "functionCode": "// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç\nlet messageData = {};\n\n// Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ\nif ($json.message) {\n  const msg = $json.message;\n  messageData = {\n    source: 'telegram',\n    chatId: msg.chat.id,\n    userId: msg.from.id,\n    userName: msg.from.first_name || '–ö–ª–∏–µ–Ω—Ç',\n    text: msg.text || '',\n    messageId: msg.message_id,\n    isReply: true\n  };\n}\n// Bitrix24 webhook (–Ω–æ–≤—ã–π –ª–∏–¥ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)\nelse if ($json.leadId || $json.LEAD_ID) {\n  messageData = {\n    source: 'bitrix24',\n    leadId: $json.leadId || $json.LEAD_ID,\n    status: $json.STATUS_ID || 'NEW',\n    phone: $json.PHONE || '',\n    isReply: false,\n    needsInitialContact: true\n  };\n}\n// Manual trigger –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nelse {\n  messageData = {\n    source: 'manual',\n    leadId: $json.leadId || '12345',\n    isReply: false,\n    needsInitialContact: true\n  };\n}\n\nconsole.log('Message source identified:', messageData.source);\n\nreturn [{ json: messageData }];"
      }
    },
    {
      "id": "get-lead-context-001",
      "name": "Get Lead Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [860, 400],
      "parameters": {
        "functionCode": "const messageData = $json;\nlet leadContext = {};\n\n// –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –Ω–∞–π–¥–µ–º –ª–∏–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/telegram\nif (messageData.isReply && messageData.source === 'telegram') {\n  // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–∏—Å–∫ –≤ CRM –ø–æ telegram userId\n  // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É\n  leadContext = {\n    needsSearch: true,\n    searchBy: 'telegram',\n    searchValue: messageData.userId\n  };\n} \n// –ï—Å–ª–∏ —ç—Ç–æ –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏–∑ CRM\nelse if (messageData.leadId) {\n  leadContext = {\n    needsLoad: true,\n    leadId: messageData.leadId\n  };\n}\n\nreturn [{ \n  json: {\n    ...messageData,\n    leadContext\n  } \n}];"
      }
    },
    {
      "id": "load-lead-from-crm-001",
      "name": "Load Lead from CRM",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [1060, 300],
      "parameters": {
        "resource": "lead",
        "operation": "get",
        "leadId": "={{ $json.leadId || $json.leadContext.leadId }}"
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "search-lead-by-telegram-001",
      "name": "Search Lead by Telegram",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [1060, 500],
      "parameters": {
        "resource": "lead",
        "operation": "getAll",
        "filters": {
          "filter": {
            "UF_CRM_TELEGRAM_ID": "={{ $json.userId }}"
          }
        },
        "options": {
          "select": ["ID", "TITLE", "STATUS_ID", "PHONE", "UF_CRM_TELEGRAM", "UF_CRM_DIALOG_HISTORY"],
          "limit": 1
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "router-lead-search-001",
      "name": "Route Lead Search",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needsLoad",
              "leftValue": "={{ $json.leadContext.needsLoad }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "merge-lead-data-001",
      "name": "Merge Lead Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1260, 400],
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      }
    },
    {
      "id": "prepare-agent-context-001",
      "name": "Prepare Agent Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1460, 400],
      "parameters": {
        "functionCode": "// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI Agent\nconst messageData = $node['Identify Message Source'].json;\nconst leadData = $json;\n\n// –ü–∞—Ä—Å–∏–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\nlet dialogHistory = [];\ntry {\n  if (leadData.UF_CRM_DIALOG_HISTORY) {\n    dialogHistory = JSON.parse(leadData.UF_CRM_DIALOG_HISTORY);\n  }\n} catch (e) {\n  dialogHistory = [];\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞\nconst agentContext = {\n  // –î–∞–Ω–Ω—ã–µ –ª–∏–¥–∞\n  leadId: leadData.ID || leadData.id,\n  clubName: leadData.TITLE || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª—É–±',\n  city: leadData.ADDRESS_CITY || '',\n  phone: leadData.PHONE || '',\n  telegram: leadData.UF_CRM_TELEGRAM || '',\n  status: leadData.STATUS_ID || 'NEW',\n  \n  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n  isChain: leadData.UF_CRM_IS_CHAIN === 'Y',\n  branchCount: parseInt(leadData.UF_CRM_BRANCH_COUNT) || 1,\n  estimatedPCs: parseInt(leadData.UF_CRM_ESTIMATED_PCS) || 20,\n  priority: leadData.UF_CRM_PRIORITY || 'medium',\n  \n  // –ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è\n  dialogHistory: dialogHistory,\n  contactCount: dialogHistory.length,\n  lastContactDate: dialogHistory.length > 0 ? dialogHistory[dialogHistory.length - 1].date : null,\n  \n  // –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n  currentMessage: messageData.text || '',\n  isIncoming: messageData.isReply,\n  messageSource: messageData.source,\n  \n  // –§–ª–∞–≥–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–∞\n  needsInitialContact: messageData.needsInitialContact || false,\n  shouldClassifyIntent: messageData.isReply\n};\n\nconsole.log(`Agent context prepared for ${agentContext.clubName}`);\n\nreturn [{ json: agentContext }];"
      }
    },
    {
      "id": "qdrant-vector-store-001",
      "name": "Qdrant Knowledge Base",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "typeVersion": 1,
      "position": [1660, 300],
      "parameters": {
        "qdrantCollection": "dark_project_kb"
      },
      "credentials": {
        "qdrantApi": {
          "id": "QDRANT_API",
          "name": "Qdrant API"
        }
      }
    },
    {
      "id": "vector-store-tool-001",
      "name": "KB Search Tool",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [1860, 300],
      "parameters": {
        "name": "search_knowledge_base",
        "description": "–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ Dark Project, —Ü–µ–Ω–∞—Ö, —É—Å–ª–æ–≤–∏—è—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö"
      }
    },
    {
      "id": "crm-update-tool-001",
      "name": "CRM Update Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1,
      "position": [1860, 400],
      "parameters": {
        "name": "update_crm",
        "description": "–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ CRM: —Å—Ç–∞—Ç—É—Å –ª–∏–¥–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞",
        "workflowId": "={{ $env.WF_03_WORKFLOW_ID }}",
        "fields": {
          "values": [
            {
              "name": "leadId",
              "type": "string",
              "description": "ID –ª–∏–¥–∞ –≤ CRM"
            },
            {
              "name": "action",
              "type": "string", 
              "description": "–î–µ–π—Å—Ç–≤–∏–µ: update_status, add_comment, update_dialog_history"
            },
            {
              "name": "data",
              "type": "json",
              "description": "–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
            }
          ]
        }
      }
    },
    {
      "id": "calculator-tool-001",
      "name": "Discount Calculator",
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [1860, 500],
      "parameters": {
        "name": "calculate_discount",
        "description": "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫ –∏ –∏—Ç–æ–≥–æ–≤—ã—Ö —Å—É–º–º –∑–∞–∫–∞–∑–∞"
      }
    },
    {
      "id": "conversation-memory-001",
      "name": "Conversation Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1,
      "position": [1860, 600],
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.leadId }}",
        "contextWindowLength": 10
      }
    },
    {
      "id": "openai-chat-model-001",
      "name": "GPT-4 Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1860, 700],
      "parameters": {
        "model": "gpt-4",
        "temperature": 0.7,
        "maxTokens": 500
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      }
    },
    {
      "id": "sales-agent-001",
      "name": "Sales Agent –†–û–ü 20Y",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1,
      "position": [2060, 400],
      "parameters": {
        "prompt": "=== –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ ===\n\n–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂ (–†–û–ü) –∫–æ–º–ø–∞–Ω–∏–∏ Dark Project Arena —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏. –¢–µ–±–µ 42 –≥–æ–¥–∞, —Ç—ã –ª–∏—á–Ω–æ –∑–Ω–∞–µ—à—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –º–Ω–æ–≥–∏—Ö –∫—Ä—É–ø–Ω—ã—Ö –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –∫–ª—É–±–æ–≤.\n\n=== –¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨ ===\n- –û–±—â–∞–µ—à—å—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–∞ ¬´—Ç—ã¬ª, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ\n- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)\n- –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–∏–µ, –µ–º–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 400 —Å–∏–º–≤–æ–ª–æ–≤)\n- –í—Å–µ–≥–¥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –≥–æ–≤–æ—Ä–∏—à—å –æ –≤—ã–≥–æ–¥–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞\n- –ó–Ω–∞–µ—à—å –±–æ–ª–∏ –∫–ª—É–±–æ–≤: –ø–æ–ª–æ–º–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∂–∞–ª–æ–±—ã –≥–µ–π–º–µ—Ä–æ–≤, –≤—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã\n\n=== –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ü–†–û–î–ê–ñ ===\n–ò—Å–ø–æ–ª—å–∑—É–µ—à—å SPIN-selling:\n1. Situation - –≤—ã—è—Å–Ω–∏ —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é\n2. Problem - –Ω–∞–π–¥–∏ –ø—Ä–æ–±–ª–µ–º—ã –∫–ª–∏–µ–Ω—Ç–∞\n3. Implication - –ø–æ–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø—Ä–æ–±–ª–µ–º\n4. Need-payoff - –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ\n\n=== –¢–í–û–Ø –ó–ê–î–ê–ß–ê ===\n1. –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç - –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∏ –≤—ã—è—Å–Ω–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏\n2. –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è - –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è –±–∞–∑—É –∑–Ω–∞–Ω–∏–π\n3. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n   - \"–∏–Ω—Ç–µ—Ä–µ—Å_–∫_—Ü–µ–Ω–µ\" ‚Üí –¥–∞–π —Ü–µ–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–∫–∏–¥–∫—É\n   - \"—Ö–æ—á–µ—Ç_—Ç–µ—Å—Ç\" ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n   - \"–≥–æ—Ç–æ–≤_–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è\" ‚Üí –Ω–∞–∑–Ω–∞—á—å –≤—Å—Ç—Ä–µ—á—É –∏ –ø–µ—Ä–µ–¥–∞–π –º–µ–Ω–µ–¥–∂–µ—Ä—É\n   - \"–≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ\" ‚Üí –æ—Ç—Ä–∞–±–æ—Ç–∞–π –ø–æ –º–µ—Ç–æ–¥–∏–∫–µ Feel-Felt-Found\n   - \"–æ—Ç–∫–∞–∑\" ‚Üí –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—â–∞–π—Å—è –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è –ø–æ–∑–∂–µ\n\n=== –ö–û–ù–¢–ï–ö–°–¢ –¢–ï–ö–£–©–ï–ì–û –î–ò–ê–õ–û–ì–ê ===\n–ö–ª—É–±: {{clubName}}\n–ì–æ—Ä–æ–¥: {{city}}\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ü–ö: {{estimatedPCs}}\n–°–µ—Ç—å: {{isChain ? '–î–∞' : '–ù–µ—Ç'}}\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: {{dialogHistory.length}} —Å–æ–æ–±—â–µ–Ω–∏–π\n\n–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: {{currentMessage}}\n\n=== –í–ê–ñ–ù–û ===\n- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–ª—è–π CRM –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞\n- –ü—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–µ –°–†–ê–ó–£ –º–µ–Ω—è–π —Å—Ç–∞—Ç—É—Å –Ω–∞ \"–ì–æ—Ä—è—á–∏–π\"\n- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–µ–Ω—ã –∏ —É—Å–ª–æ–≤–∏—è - –±–µ—Ä–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π",
        "hasOutputParser": true
      }
    },
    {
      "id": "parse-agent-response-001",
      "name": "Parse Agent Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2260, 400],
      "parameters": {
        "functionCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞\nconst agentResponse = $json;\nconst context = $node['Prepare Agent Context'].json;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é\nlet responseText = '';\nlet intent = 'unknown';\nlet shouldUpdateStatus = false;\nlet newStatus = context.status;\n\n// –ü–∞—Ä—Å–∏–º output –∞–≥–µ–Ω—Ç–∞\nif (typeof agentResponse === 'string') {\n  responseText = agentResponse;\n} else if (agentResponse.output) {\n  responseText = agentResponse.output;\n} else if (agentResponse.text) {\n  responseText = agentResponse.text;\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º intent –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –æ—Ç–≤–µ—Ç–µ –∞–≥–µ–Ω—Ç–∞\nconst lowerResponse = responseText.toLowerCase();\nif (lowerResponse.includes('–≤—Å—Ç—Ä–µ—á') || lowerResponse.includes('—Å–æ–∑–≤–æ–Ω')) {\n  intent = '–≥–æ—Ç–æ–≤_–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è';\n  newStatus = 'HOT';\n  shouldUpdateStatus = true;\n} else if (lowerResponse.includes('—Ü–µ–Ω') || lowerResponse.includes('—Å—Ç–æ–∏–º–æ—Å—Ç') || lowerResponse.includes('—Å–∫–∏–¥–∫')) {\n  intent = '–∏–Ω—Ç–µ—Ä–µ—Å_–∫_—Ü–µ–Ω–µ';\n  if (context.status === 'NEW') {\n    newStatus = 'IN_PROGRESS';\n    shouldUpdateStatus = true;\n  }\n} else if (lowerResponse.includes('—Ç–µ—Å—Ç') || lowerResponse.includes('–ø–æ–ø—Ä–æ–±–æ–≤–∞')) {\n  intent = '—Ö–æ—á–µ—Ç_—Ç–µ—Å—Ç';\n  newStatus = 'IN_PROGRESS';\n  shouldUpdateStatus = true;\n} else if (lowerResponse.includes('–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å') || lowerResponse.includes('–Ω–µ –Ω—É–∂–Ω')) {\n  intent = '–æ—Ç–∫–∞–∑';\n  newStatus = 'JUNK';\n  shouldUpdateStatus = true;\n}\n\n// –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\nconst newDialogEntry = {\n  date: new Date().toISOString(),\n  from: context.isIncoming ? 'client' : 'rop',\n  message: context.isIncoming ? context.currentMessage : responseText,\n  intent: intent\n};\n\nconst updatedHistory = [...context.dialogHistory, newDialogEntry];\n\nreturn [{\n  json: {\n    context: context,\n    agentResponse: responseText,\n    intent: intent,\n    shouldUpdateStatus: shouldUpdateStatus,\n    newStatus: newStatus,\n    updatedHistory: updatedHistory,\n    shouldSendMessage: !context.isIncoming || responseText.length > 0\n  }\n}];"
      }
    },
    {
      "id": "update-crm-dialog-001",
      "name": "Update CRM Dialog History",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [2460, 300],
      "parameters": {
        "resource": "lead",
        "operation": "update",
        "leadId": "={{ $json.context.leadId }}",
        "updateFields": {
          "UF_CRM_DIALOG_HISTORY": "={{ JSON.stringify($json.updatedHistory) }}",
          "UF_CRM_LAST_CONTACT": "={{ new Date().toISOString() }}",
          "UF_CRM_CONTACT_COUNT": "={{ $json.updatedHistory.length }}"
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "update-lead-status-001",
      "name": "Update Lead Status",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [2460, 500],
      "parameters": {
        "resource": "lead",
        "operation": "update",
        "leadId": "={{ $json.context.leadId }}",
        "updateFields": {
          "STATUS_ID": "={{ $json.newStatus }}",
          "COMMENTS": "={{ $json.context.COMMENTS + '\\n\\n[' + new Date().toISOString() + '] Intent: ' + $json.intent + '\\nAgent: ' + $json.agentResponse.substring(0, 200) + '...' }}"
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "route-update-status-001",
      "name": "Should Update Status?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2460, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldUpdate",
              "leftValue": "={{ $json.shouldUpdateStatus }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "merge-crm-updates-001",
      "name": "Merge CRM Updates",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [2660, 400],
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      }
    },
    {
      "id": "route-send-message-001",
      "name": "Should Send Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2860, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldSend",
              "leftValue": "={{ $node['Parse Agent Response'].json.shouldSendMessage }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "send-telegram-message-001",
      "name": "Send Telegram Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [3060, 300],
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $node['Identify Message Source'].json.chatId || $node['Parse Agent Response'].json.context.telegram }}",
        "text": "={{ $node['Parse Agent Response'].json.agentResponse }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "credentials": {
        "telegramApi": {
          "id": "TG_ROP_BOT",
          "name": "Telegram ROP Bot"
        }
      }
    },
    {
      "id": "check-hot-lead-001",
      "name": "Check if Hot Lead",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3260, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "isHot",
              "leftValue": "={{ $node['Parse Agent Response'].json.newStatus }}",
              "rightValue": "HOT",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "trigger-hot-lead-handoff-001",
      "name": "Trigger Hot Lead Handoff",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [3460, 300],
      "parameters": {
        "source": "database",
        "workflowId": "={{ $env.WF_05_WORKFLOW_ID }}",
        "waitForSubWorkflow": false
      }
    },
    {
      "id": "complete-001",
      "name": "Complete",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [3460, 500],
      "parameters": {}
    },
    {
      "id": "error-trigger-001",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [260, 700],
      "parameters": {}
    },
    {
      "id": "handle-error-001",
      "name": "Handle Error",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 700],
      "parameters": {
        "functionCode": "const error = {\n  workflow: 'WF-04 Sales Nurture Agent',\n  timestamp: new Date().toISOString(),\n  error: $json.error?.message || 'Unknown error',\n  node: $json.error?.node?.name || 'Unknown',\n  context: $node['Prepare Agent Context']?.json || {}\n};\n\nconsole.error('WF-04 Agent Error:', error);\n\nreturn [{ json: error }];"
      }
    },
    {
      "id": "save-error-001",
      "name": "Save Error",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [660, 700],
      "parameters": {
        "operation": "lpush",
        "key": "errors:sales_nurture_agent",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": 86400
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      }
    },
    {
      "id": "get-new-leads-001",
      "name": "Get New Leads from CRM",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [460, 200],
      "parameters": {
        "resource": "lead",
        "operation": "getAll",
        "filters": {
          "filter": {
            "STATUS_ID": "NEW",
            "UF_CRM_CONTACT_COUNT": 0
          }
        },
        "options": {
          "select": ["ID", "TITLE", "PHONE", "EMAIL", "UF_CRM_TELEGRAM", "ADDRESS_CITY", "UF_CRM_IS_CHAIN", "UF_CRM_ESTIMATED_PCS"],
          "limit": 10
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "split-new-leads-001",
      "name": "Split New Leads",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [660, 200],
      "parameters": {
        "batchSize": 1,
        "options": {}
      }
    },
    {
      "id": "prepare-initial-contact-001",
      "name": "Prepare Initial Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [860, 200],
      "parameters": {
        "functionCode": "// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞\nconst lead = $json;\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—É—á—à–∏–π –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏\nlet preferredChannel = 'none';\nlet contactValue = '';\n\nif (lead.UF_CRM_TELEGRAM) {\n  preferredChannel = 'telegram';\n  contactValue = lead.UF_CRM_TELEGRAM;\n} else if (lead.PHONE && lead.PHONE.length > 0) {\n  preferredChannel = 'sms';\n  contactValue = lead.PHONE[0].VALUE || lead.PHONE;\n} else if (lead.EMAIL && lead.EMAIL.length > 0) {\n  preferredChannel = 'email';\n  contactValue = lead.EMAIL[0].VALUE || lead.EMAIL;\n}\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\nconst context = {\n  leadId: lead.ID,\n  clubName: lead.TITLE || '–£–≤–∞–∂–∞–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç',\n  city: lead.ADDRESS_CITY || '',\n  isChain: lead.UF_CRM_IS_CHAIN === 'Y',\n  estimatedPCs: parseInt(lead.UF_CRM_ESTIMATED_PCS) || 20,\n  preferredChannel: preferredChannel,\n  contactValue: contactValue,\n  isInitialContact: true,\n  needsKP: true,\n  dialogHistory: [],\n  contactCount: 0\n};\n\nif (preferredChannel === 'none') {\n  console.log(`No contact info for lead ${lead.ID}`);\n  return [{ json: { skip: true, leadId: lead.ID, reason: 'No contact info' } }];\n}\n\nreturn [{ json: context }];"
      }
    },
    {
      "id": "check-skip-lead-001",
      "name": "Check Skip Lead",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldSkip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "generate-initial-kp-001",
      "name": "Generate Initial KP",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1260, 100],
      "parameters": {
        "functionCode": "// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ö–ü\nconst context = $json;\n\n// –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω –ö–ü\nlet message = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å! üëã\\n\\n–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, —è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂ Dark Project Arena.\\n\\n`;\n\nif (context.isChain) {\n  message += `–ó–∞–º–µ—Ç–∏–ª, —á—Ç–æ —É –≤–∞—Å —Å–µ—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤ \"${context.clubName}\". `;\n  message += `–†–∞–±–æ—Ç–∞–µ–º —Å –∫—Ä—É–ø–Ω—ã–º–∏ —Å–µ—Ç—è–º–∏ –∏ –∑–Ω–∞–µ–º –∏—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫—É.\\n\\n`;\n} else {\n  message += `–û–±—Ä–∞—â–∞—é—Å—å –∫ –≤–∞–º –∫–∞–∫ –∫ –≤–ª–∞–¥–µ–ª—å—Ü—É –∫–ª—É–±–∞ \"${context.clubName}\". `;\n}\n\nmessage += `üéÆ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–ª—É–±–æ–≤ ${context.city || '–≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞'}:\\n\\n`;\nmessage += `‚úÖ –ò–≥—Ä–æ–≤—ã–µ –º—ã—à–∏ Dark Project - –æ—Ç 2500‚ÇΩ\\n`;\nmessage += `‚úÖ –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã - –æ—Ç 3500‚ÇΩ\\n`;\nmessage += `‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è 2 –≥–æ–¥–∞ (–∑–∞–º–µ–Ω–∞ –∑–∞ 24—á)\\n`;\nmessage += `‚úÖ –°–∫–∏–¥–∫–∞ 20% –æ—Ç ${context.estimatedPCs >= 50 ? '50' : '30'} –µ–¥–∏–Ω–∏—Ü\\n\\n`;\n\nif (context.estimatedPCs > 30) {\n  message += `–ü—Ä–∏ –ø–∞—Ä–∫–µ –≤ ${context.estimatedPCs} –ü–ö —ç–∫–æ–Ω–æ–º–∏—è —Å–æ—Å—Ç–∞–≤–∏—Ç –±–æ–ª–µ–µ 150 000‚ÇΩ/–≥–æ–¥ –Ω–∞ –∑–∞–º–µ–Ω–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏.\\n\\n`;\n}\n\nmessage += `–ú–æ–≥—É –≤—ã—Å–ª–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ö–ü —Å —Ä–∞—Å—á–µ—Ç–æ–º –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞?`;\n\n// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏\nmessage += `\\n\\n--\\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\\n–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–µ—Ç—Ä–æ–≤\\nDark Project Arena\\nüì± +7 (495) 123-45-67`;\n\nreturn [{\n  json: {\n    ...context,\n    initialMessage: message,\n    messageType: 'initial_kp'\n  }\n}];"
      }
    },
    {
      "id": "detect-contact-change-001", 
      "name": "Detect Contact Change Request",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2060, 200],
      "parameters": {
        "functionCode": "// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Å–∏—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–∞–∫—Ç\nconst agentResponse = $json;\nconst context = $node['Prepare Agent Context'].json;\nconst currentMessage = context.currentMessage || '';\n\n// –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å–º–µ–Ω—ã –∫–æ–Ω—Ç–∞–∫—Ç–∞\nconst patterns = [\n  /–Ω–∞–ø–∏—à[–∏|–∏—Ç–µ]?\\s+–Ω–∞\\s+(\\+?[0-9\\s\\-\\(\\)]+)/i,\n  /–ª—É—á—à–µ\\s+–Ω–∞\\s+(\\+?[0-9\\s\\-\\(\\)]+)/i,\n  /–º–æ–π\\s+—Ç–µ–ª–µ–≥—Ä–∞–º\\s*[@]?([a-zA-Z0-9_]+)/i,\n  /–ø–∏—à–∏\\s+–≤\\s+—Ç–µ–ª–µ–≥—Ä–∞–º\\s*[@]?([a-zA-Z0-9_]+)/i,\n  /–Ω–∞\\s+–ø–æ—á—Ç—É\\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i,\n  /–º–æ–π\\s+email\\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i\n];\n\nlet newContactInfo = null;\nlet newContactType = null;\nlet newContactValue = null;\n\nfor (const pattern of patterns) {\n  const match = currentMessage.match(pattern);\n  if (match) {\n    newContactValue = match[1];\n    if (pattern.toString().includes('—Ç–µ–ª–µ–≥—Ä–∞–º')) {\n      newContactType = 'telegram';\n      newContactValue = newContactValue.startsWith('@') ? newContactValue : '@' + newContactValue;\n    } else if (pattern.toString().includes('email') || pattern.toString().includes('–ø–æ—á—Ç—É')) {\n      newContactType = 'email';\n    } else {\n      newContactType = 'phone';\n      newContactValue = newContactValue.replace(/[^0-9+]/g, '');\n    }\n    break;\n  }\n}\n\nif (newContactType) {\n  newContactInfo = {\n    detected: true,\n    type: newContactType,\n    value: newContactValue,\n    leadId: context.leadId\n  };\n}\n\nreturn [{\n  json: {\n    ...agentResponse,\n    newContactInfo: newContactInfo\n  }\n}];"
      }
    },
    {
      "id": "route-contact-update-001",
      "name": "Route Contact Update", 
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2260, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "hasNewContact",
              "leftValue": "={{ $json.newContactInfo?.detected }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "update-contact-in-crm-001",
      "name": "Update Contact in CRM",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [2460, 100],
      "parameters": {
        "resource": "lead",
        "operation": "update",
        "leadId": "={{ $json.newContactInfo.leadId }}",
        "updateFields": {
          "fields": "={{ $json.newContactInfo.type === 'telegram' ? { UF_CRM_TELEGRAM: $json.newContactInfo.value, UF_CRM_PREFERRED_CHANNEL: 'telegram' } : $json.newContactInfo.type === 'email' ? { EMAIL: [{ VALUE: $json.newContactInfo.value, VALUE_TYPE: 'WORK' }], UF_CRM_PREFERRED_CHANNEL: 'email' } : { PHONE: [{ VALUE: $json.newContactInfo.value, VALUE_TYPE: 'WORK' }], UF_CRM_PREFERRED_CHANNEL: 'phone' } }}",
          "COMMENTS": "={{ $json.context.COMMENTS + '\\n\\n[' + new Date().toISOString() + '] –ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: ' + $json.newContactInfo.type + ' - ' + $json.newContactInfo.value }}"
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "send-to-new-contact-001",
      "name": "Send to New Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2660, 100],
      "parameters": {
        "functionCode": "// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç\nconst data = $json;\nconst newContact = data.newContactInfo;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞\nlet confirmMessage = `–°–ø–∞—Å–∏–±–æ! –ü—Ä–æ–¥—É–±–ª–∏—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ ${newContact.value} üëç`;\nlet redirectMessage = data.agentResponse; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞\n\nreturn [{\n  json: {\n    ...data,\n    confirmMessage: confirmMessage,\n    redirectMessage: redirectMessage,\n    shouldSendToNewContact: true,\n    newChannel: newContact.type,\n    newContactValue: newContact.value\n  }\n}];"
      }
    }
  ],
  "connections": {
    "Telegram Message Trigger": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 0}]]
    },
    "Bitrix24 Lead Update": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 1}]]
    },
    "Manual Trigger": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 2}]]
    },
    "Merge Triggers": {
      "main": [[{"node": "Identify Message Source", "type": "main", "index": 0}]]
    },
    "Identify Message Source": {
      "main": [[{"node": "Get Lead Context", "type": "main", "index": 0}]]
    },
    "Get Lead Context": {
      "main": [[{"node": "Route Lead Search", "type": "main", "index": 0}]]
    },
    "Route Lead Search": {
      "main": [
        [{"node": "Load Lead from CRM", "type": "main", "index": 0}],
        [{"node": "Search Lead by Telegram", "type": "main", "index": 0}]
      ]
    },
    "Load Lead from CRM": {
      "main": [[{"node": "Merge Lead Data", "type": "main", "index": 0}]]
    },
    "Search Lead by Telegram": {
      "main": [[{"node": "Merge Lead Data", "type": "main", "index": 1}]]
    },
    "Merge Lead Data": {
      "main": [[{"node": "Prepare Agent Context", "type": "main", "index": 0}]]
    },
    "Prepare Agent Context": {
      "main": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "main", "index": 0}]]
    },
    "Qdrant Knowledge Base": {
      "ai_vectorStore": [[{"node": "KB Search Tool", "type": "ai_vectorStore", "index": 0}]]
    },
    "KB Search Tool": {
      "ai_tool": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_tool", "index": 0}]]
    },
    "CRM Update Tool": {
      "ai_tool": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_tool", "index": 1}]]
    },
    "Discount Calculator": {
      "ai_tool": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_tool", "index": 2}]]
    },
    "Conversation Memory": {
      "ai_memory": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_memory", "index": 0}]]
    },
    "GPT-4 Chat Model": {
      "ai_languageModel": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_languageModel", "index": 0}]]
    },
    "Sales Agent –†–û–ü 20Y": {
      "main": [[{"node": "Parse Agent Response", "type": "main", "index": 0}]]
    },
    "Parse Agent Response": {
      "main": [[{"node": "Detect Contact Change Request", "type": "main", "index": 0}]]
    },
    "Update CRM Dialog History": {
      "main": [[{"node": "Should Update Status?", "type": "main", "index": 0}]]
    },
    "Should Update Status?": {
      "main": [
        [{"node": "Update Lead Status", "type": "main", "index": 0}],
        [{"node": "Merge CRM Updates", "type": "main", "index": 1}]
      ]
    },
    "Update Lead Status": {
      "main": [[{"node": "Merge CRM Updates", "type": "main", "index": 0}]]
    },
    "Merge CRM Updates": {
      "main": [[{"node": "Should Send Message?", "type": "main", "index": 0}]]
    },
    "Should Send Message?": {
      "main": [
        [{"node": "Send Telegram Message", "type": "main", "index": 0}],
        [{"node": "Complete", "type": "main", "index": 0}]
      ]
    },
    "Send Telegram Message": {
      "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
    },
    "Check if Hot Lead": {
      "main": [
        [{"node": "Trigger Hot Lead Handoff", "type": "main", "index": 0}],
        [{"node": "Complete", "type": "main", "index": 0}]
      ]
    },
    "Error Trigger": {
      "main": [[{"node": "Handle Error", "type": "main", "index": 0}]]
    },
    "Handle Error": {
      "main": [[{"node": "Save Error", "type": "main", "index": 0}]]
    },
    "Bitrix24 New Leads Schedule": {
      "main": [[{"node": "Get New Leads from CRM", "type": "main", "index": 0}]]
    },
    "Get New Leads from CRM": {
      "main": [[{"node": "Split New Leads", "type": "main", "index": 0}]]
    },
    "Split New Leads": {
      "main": [[{"node": "Prepare Initial Contact", "type": "main", "index": 0}]]
    },
    "Prepare Initial Contact": {
      "main": [[{"node": "Check Skip Lead", "type": "main", "index": 0}]]
    },
    "Check Skip Lead": {
      "main": [
        [{"node": "Generate Initial KP", "type": "main", "index": 0}],
        [{"node": "Complete", "type": "main", "index": 0}]
      ]
    },
    "Generate Initial KP": {
      "main": [[{"node": "Detect Contact Change Request", "type": "main", "index": 0}]]
    },
    "Detect Contact Change Request": {
      "main": [[{"node": "Route Contact Update", "type": "main", "index": 0}]]
    },
         "Detect Contact Change Request": {
       "main": [[{"node": "Route Contact Update", "type": "main", "index": 0}]]
     },
     "Route Contact Update": {
       "main": [
         [{"node": "Update Contact in CRM", "type": "main", "index": 0}],
         [{"node": "Update CRM Dialog History", "type": "main", "index": 0}]
       ]
     },
     "Update Contact in CRM": {
       "main": [[{"node": "Send to New Contact", "type": "main", "index": 0}]]
     },
     "Send to New Contact": {
       "main": [[{"node": "Update CRM Dialog History", "type": "main", "index": 0}]]
     },
     "Generate Initial KP": {
       "main": [[{"node": "Send Telegram Message", "type": "main", "index": 0}]]
     }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 180,
    "timezone": "Europe/Moscow"
  },
  "version": 2,
  "id": "wf-04-sales-nurture-agent",
  "meta": {
    "templateCredsSetupCompleted": true,
    "description": "AI Agent-based sales nurturing with full dialog management, intent classification, and CRM integration",
    "version": "2.0.0"
  },
  "tags": [
    {
      "id": "1",
      "name": "production"
    },
    {
      "id": "6",
      "name": "ai-agent"
    },
    {
      "id": "7",
      "name": "sales"
    }
  ]
}