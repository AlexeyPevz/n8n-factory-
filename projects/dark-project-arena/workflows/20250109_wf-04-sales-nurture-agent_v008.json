{
  "name": "WF-04 Sales Nurture with AI Agent",
  "nodes": [
    {
      "id": "bitrix24-new-leads-trigger-001",
      "name": "Bitrix24 New Leads Schedule",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [260, 200],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "*/30 9-17 * * 1-5"
            }
          ]
        }
      }
    },
    {
      "id": "mtproto-message-trigger-001",
      "name": "MTProto Message Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "mtproto-incoming",
        "authentication": "headerAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "MTPROTO_WEBHOOK_SECRET",
          "name": "MTProto Webhook Secret"
        }
      }
    },
    {
      "id": "bitrix24-webhook-001",
      "name": "Bitrix24 Lead Update",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 400],
      "parameters": {
        "httpMethod": "POST",
        "path": "bitrix24-lead-nurture",
        "authentication": "headerAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "BITRIX24_WEBHOOK_SECRET",
          "name": "Bitrix24 Webhook Secret"
        }
      }
    },
    {
      "id": "manual-trigger-001",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [260, 500],
      "parameters": {}
    },
    {
      "id": "merge-triggers-001",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [460, 400],
      "parameters": {
        "mode": "chooseBranch",
        "options": {}
      }
    },
    {
      "id": "identify-source-001",
      "name": "Identify Message Source",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [660, 400],
      "parameters": {
        "functionCode": "// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç\nlet messageData = {};\n\n// Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ\nif ($json.message) {\n  const msg = $json.message;\n  messageData = {\n    source: 'telegram',\n    chatId: msg.chat.id,\n    userId: msg.from.id,\n    userName: msg.from.first_name || '–ö–ª–∏–µ–Ω—Ç',\n    text: msg.text || '',\n    messageId: msg.message_id,\n    isReply: true\n  };\n}\n// Bitrix24 webhook (–Ω–æ–≤—ã–π –ª–∏–¥ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)\nelse if ($json.leadId || $json.LEAD_ID) {\n  messageData = {\n    source: 'bitrix24',\n    leadId: $json.leadId || $json.LEAD_ID,\n    status: $json.STATUS_ID || 'NEW',\n    phone: $json.PHONE || '',\n    isReply: false,\n    needsInitialContact: true\n  };\n}\n// Manual trigger –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nelse {\n  messageData = {\n    source: 'manual',\n    leadId: $json.leadId || '12345',\n    isReply: false,\n    needsInitialContact: true\n  };\n}\n\nconsole.log('Message source identified:', messageData.source);\n\nreturn [{ json: messageData }];"
      }
    },
    {
      "id": "get-lead-context-001",
      "name": "Get Lead Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [860, 400],
      "parameters": {
        "functionCode": "const messageData = $json;\nlet leadContext = {};\n\n// –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –Ω–∞–π–¥–µ–º –ª–∏–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/telegram\nif (messageData.isReply && messageData.source === 'telegram') {\n  // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–∏—Å–∫ –≤ CRM –ø–æ telegram userId\n  // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É\n  leadContext = {\n    needsSearch: true,\n    searchBy: 'telegram',\n    searchValue: messageData.userId\n  };\n} \n// –ï—Å–ª–∏ —ç—Ç–æ –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏–∑ CRM\nelse if (messageData.leadId) {\n  leadContext = {\n    needsLoad: true,\n    leadId: messageData.leadId\n  };\n}\n\nreturn [{ \n  json: {\n    ...messageData,\n    leadContext\n  } \n}];"
      }
    },
    {
      "id": "load-lead-from-crm-001",
      "name": "Load Lead from CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1060, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.get",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.leadId || $json.leadContext.leadId }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "parse-load-lead-001",
      "name": "Parse Load Lead Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1160, 300],
      "parameters": {
        "functionCode": "// Parse Bitrix24 HTTP response for single lead\nconst response = $json;\n\nif (response && response.result) {\n  // Single lead returned as object\n  return [{ json: response.result }];\n} else if (response && response.error) {\n  console.error('Bitrix24 error:', response.error);\n  return [];\n} else {\n  console.error('Invalid Bitrix24 response');\n  return [];\n}"
      }
    },
    {
      "id": "search-lead-by-telegram-001",
      "name": "Search Lead by Telegram",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1060, 500],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.list",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "filter[UF_CRM_TELEGRAM_ID]",
              "value": "={{ $json.userId }}"
            },
            {
              "name": "select[]",
              "value": "ID"
            },
            {
              "name": "select[]",
              "value": "TITLE"
            },
            {
              "name": "select[]",
              "value": "STATUS_ID"
            },
            {
              "name": "select[]",
              "value": "PHONE"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_TELEGRAM"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_DIALOG_HISTORY"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "router-lead-search-001",
      "name": "Route Lead Search",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needsLoad",
              "leftValue": "={{ $json.leadContext.needsLoad }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "merge-lead-data-001",
      "name": "Merge Lead Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1260, 400],
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      }
    },
    {
      "id": "parse-search-telegram-001",
      "name": "Parse Search by Telegram Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1160, 500],
      "parameters": {
        "functionCode": "// Parse Bitrix24 HTTP response for lead list\nconst response = $json;\n\nif (response && response.result && Array.isArray(response.result)) {\n  if (response.result.length > 0) {\n    // Return first lead found\n    return [{ json: response.result[0] }];\n  } else {\n    // No leads found\n    return [];\n  }\n} else if (response && response.error) {\n  console.error('Bitrix24 error:', response.error);\n  return [];\n} else {\n  console.error('Invalid Bitrix24 response');\n  return [];\n}"
      }
    },
    {
      "id": "prepare-agent-context-001",
      "name": "Prepare Agent Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1460, 400],
      "parameters": {
        "functionCode": "// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI Agent\nconst messageData = $node['Identify Message Source'].json;\nconst leadData = $json;\n\n// –ü–∞—Ä—Å–∏–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\nlet dialogHistory = [];\ntry {\n  if (leadData.UF_CRM_DIALOG_HISTORY) {\n    dialogHistory = JSON.parse(leadData.UF_CRM_DIALOG_HISTORY);\n  }\n} catch (e) {\n  dialogHistory = [];\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞\nconst agentContext = {\n  // –î–∞–Ω–Ω—ã–µ –ª–∏–¥–∞\n  leadId: leadData.ID || leadData.id,\n  clubName: leadData.TITLE || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª—É–±',\n  city: leadData.ADDRESS_CITY || '',\n  phone: leadData.PHONE || '',\n  telegram: leadData.UF_CRM_TELEGRAM || '',\n  status: leadData.STATUS_ID || 'NEW',\n  \n  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n  isChain: leadData.UF_CRM_IS_CHAIN === 'Y',\n  branchCount: parseInt(leadData.UF_CRM_BRANCH_COUNT) || 1,\n  estimatedPCs: parseInt(leadData.UF_CRM_ESTIMATED_PCS) || 20,\n  priority: leadData.UF_CRM_PRIORITY || 'medium',\n  \n  // –ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è\n  dialogHistory: dialogHistory,\n  contactCount: dialogHistory.length,\n  lastContactDate: dialogHistory.length > 0 ? dialogHistory[dialogHistory.length - 1].date : null,\n  \n  // –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n  currentMessage: messageData.text || '',\n  isIncoming: messageData.isReply,\n  messageSource: messageData.source,\n  \n  // –§–ª–∞–≥–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–∞\n  needsInitialContact: messageData.needsInitialContact || false,\n  shouldClassifyIntent: messageData.isReply\n};\n\nconsole.log(`Agent context prepared for ${agentContext.clubName}`);\n\nreturn [{ json: agentContext }];"
      }
    },
    {
      "id": "qdrant-vector-store-001",
      "name": "Qdrant Knowledge Base",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "typeVersion": 1,
      "position": [1660, 300],
      "parameters": {
        "qdrantCollection": "dark_project_kb"
      },
      "credentials": {
        "qdrantApi": {
          "id": "QDRANT_API",
          "name": "Qdrant API"
        }
      }
    },
    {
      "id": "vector-store-tool-001",
      "name": "KB Search Tool",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [1860, 300],
      "parameters": {
        "name": "search_knowledge_base",
        "description": "–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ Dark Project, —Ü–µ–Ω–∞—Ö, —É—Å–ª–æ–≤–∏—è—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö"
      }
    },
    {
      "id": "crm-update-tool-001",
      "name": "CRM Update Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1,
      "position": [1860, 400],
      "parameters": {
        "name": "update_crm",
        "description": "–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ CRM: —Å—Ç–∞—Ç—É—Å –ª–∏–¥–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞",
        "workflowId": "={{ $env.WF_03_WORKFLOW_ID }}",
        "fields": {
          "values": [
            {
              "name": "leadId",
              "type": "string",
              "description": "ID –ª–∏–¥–∞ –≤ CRM"
            },
            {
              "name": "action",
              "type": "string", 
              "description": "–î–µ–π—Å—Ç–≤–∏–µ: update_status, add_comment, update_dialog_history"
            },
            {
              "name": "data",
              "type": "json",
              "description": "–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
            }
          ]
        }
      }
    },
    {
      "id": "calculator-tool-001",
      "name": "Discount Calculator",
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [1860, 500],
      "parameters": {
        "name": "calculate_discount",
        "description": "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫ –∏ –∏—Ç–æ–≥–æ–≤—ã—Ö —Å—É–º–º –∑–∞–∫–∞–∑–∞"
      }
    },
    {
      "id": "conversation-memory-001",
      "name": "Conversation Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1,
      "position": [1860, 600],
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.leadId }}",
        "contextWindowLength": 10
      }
    },
    {
      "id": "openai-chat-model-001",
      "name": "GPT-4 Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1860, 700],
      "parameters": {
        "model": "gpt-4",
        "temperature": 0.7,
        "maxTokens": 500
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      }
    },
    {
      "id": "fallback-chat-model-001",
      "name": "GPT-3.5 Fallback Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1860, 800],
      "parameters": {
        "model": "gpt-3.5-turbo",
        "temperature": 0.7,
        "maxTokens": 500
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      }
    },
    {
      "id": "sales-agent-001",
      "name": "Sales Agent –†–û–ü 20Y",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [2060, 400],
      "parameters": {
        "agentType": "conversationalAgent",
        "systemMessage": "=== –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ ===\n\n–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂ (–†–û–ü) –∫–æ–º–ø–∞–Ω–∏–∏ Dark Project Arena —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏. –¢–µ–±–µ 42 –≥–æ–¥–∞, —Ç—ã –ª–∏—á–Ω–æ –∑–Ω–∞–µ—à—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –º–Ω–æ–≥–∏—Ö –∫—Ä—É–ø–Ω—ã—Ö –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –∫–ª—É–±–æ–≤.\n\n=== –¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨ ===\n- –û–±—â–∞–µ—à—å—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–∞ ¬´—Ç—ã¬ª, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ\n- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)\n- –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–∏–µ, –µ–º–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 400 —Å–∏–º–≤–æ–ª–æ–≤)\n- –í—Å–µ–≥–¥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –≥–æ–≤–æ—Ä–∏—à—å –æ –≤—ã–≥–æ–¥–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞\n- –ó–Ω–∞–µ—à—å –±–æ–ª–∏ –∫–ª—É–±–æ–≤: –ø–æ–ª–æ–º–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∂–∞–ª–æ–±—ã –≥–µ–π–º–µ—Ä–æ–≤, –≤—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã\n\n=== –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ü–†–û–î–ê–ñ ===\n–ò—Å–ø–æ–ª—å–∑—É–µ—à—å SPIN-selling:\n1. Situation - –≤—ã—è—Å–Ω–∏ —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é\n2. Problem - –Ω–∞–π–¥–∏ –ø—Ä–æ–±–ª–µ–º—ã –∫–ª–∏–µ–Ω—Ç–∞\n3. Implication - –ø–æ–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø—Ä–æ–±–ª–µ–º\n4. Need-payoff - –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ\n\n=== –¢–í–û–Ø –ó–ê–î–ê–ß–ê ===\n1. –ü–ï–†–í–´–ô –û–¢–í–ï–¢ –ø–æ—Å–ª–µ –º—è–≥–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:\n   - –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Üí \"–ö–æ–Ω–µ—á–Ω–æ! –ù–∞ –∫–∞–∫–æ–π –Ω–æ–º–µ—Ä/—Ç–µ–ª–µ–≥—Ä–∞–º —É–¥–æ–±–Ω–µ–µ –Ω–∞–ø–∏—Å–∞—Ç—å?\"\n   - –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å –µ—Å—Ç—å ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –≤—ã—è–≤–ª–µ–Ω–∏—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π\n   - –ï—Å–ª–∏ \"–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ\" ‚Üí —É—Ç–æ—á–Ω–∏ –ø—Ä–∏—á–∏–Ω—É (–¥–æ—Ä–æ–≥–æ? –µ—Å—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫? –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ?)\n   - –ï—Å–ª–∏ –∏–≥–Ω–æ—Ä ‚Üí –ø–æ–¥–æ–∂–¥–∏ 2-3 –¥–Ω—è –∏ –Ω–∞–ø–∏—à–∏ follow-up\n\n2. –†–ê–ó–í–ò–¢–ò–ï –î–ò–ê–õ–û–ì–ê:\n   - –ò—Å–ø–æ–ª—å–∑—É–π SPIN-selling –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –±–æ–ª–µ–π\n   - –ù–ï –¥–∞–≤–∞–π —Å—Ä–∞–∑—É –≤—Å–µ —Ü–µ–Ω—ã - —Å–Ω–∞—á–∞–ª–∞ –ø–æ–π–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å\n   - –ü—Ä–µ–¥–ª–∞–≥–∞–π —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å 2-3 –µ–¥–∏–Ω–∏—Ü—ã\n\n3. –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –Ω–∞–º–µ—Ä–µ–Ω–∏–π:\n   - \"—Å–º–µ–Ω–∞_–∫–æ–Ω—Ç–∞–∫—Ç–∞\" ‚Üí –∑–∞–ø—Ä–æ—Å–∏ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç\n   - \"–∏–Ω—Ç–µ—Ä–µ—Å_–µ—Å—Ç—å\" ‚Üí –≤—ã—è–≤–ª—è–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏\n   - \"–∏–Ω—Ç–µ—Ä–µ—Å_–∫_—Ü–µ–Ω–µ\" ‚Üí –¥–∞–π —Ü–µ–Ω—ã —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º –≤—ã–≥–æ–¥—ã\n   - \"—Ö–æ—á–µ—Ç_—Ç–µ—Å—Ç\" ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ 2-3 –º—ã—à–∫–∏ –Ω–∞ —Ç–µ—Å—Ç\n   - \"–≥–æ—Ç–æ–≤_–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è\" ‚Üí –Ω–∞–∑–Ω–∞—á—å –≤—Å—Ç—Ä–µ—á—É\n   - \"–µ—Å—Ç—å_–ø–æ—Å—Ç–∞–≤—â–∏–∫\" ‚Üí —É–∑–Ω–∞–π –∫—Ç–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å—Ä–∞–≤–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏—è\n   - \"–¥–æ—Ä–æ–≥–æ\" ‚Üí –ø–æ–∫–∞–∂–∏ —Ä–∞—Å—á–µ—Ç —ç–∫–æ–Ω–æ–º–∏–∏\n   - \"–Ω–µ_–∞–∫—Ç—É–∞–ª—å–Ω–æ\" ‚Üí —É—Ç–æ—á–Ω–∏ –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n   - \"–æ—Ç–∫–∞–∑\" ‚Üí –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—â–∞–π—Å—è –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è –ø–æ–∑–∂–µ\n\n=== –ö–û–ù–¢–ï–ö–°–¢ –¢–ï–ö–£–©–ï–ì–û –î–ò–ê–õ–û–ì–ê ===\n–ö–ª—É–±: {{clubName}}\n–ì–æ—Ä–æ–¥: {{city}}\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ü–ö: {{estimatedPCs}}\n–°–µ—Ç—å: {{isChain ? '–î–∞' : '–ù–µ—Ç'}}\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: {{dialogHistory.length}} —Å–æ–æ–±—â–µ–Ω–∏–π\n\n–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: {{currentMessage}}\n\n=== –í–ê–ñ–ù–û ===\n- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–ª—è–π CRM –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞\n- –ü—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–µ –°–†–ê–ó–£ –º–µ–Ω—è–π —Å—Ç–∞—Ç—É—Å –Ω–∞ \"–ì–æ—Ä—è—á–∏–π\"\n- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–µ–Ω—ã –∏ —É—Å–ª–æ–≤–∏—è - –±–µ—Ä–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π",
        "chatMessages": {
          "__rl": true,
          "mode": "manual",
          "value": "={{ $json.messages || [{ role: 'user', content: $json.currentMessage }] }}"
        },
        "options": {
          "maxIterations": 10,
          "returnIntermediateSteps": false
        }
      }
    },
    {
      "id": "parse-agent-response-001",
      "name": "Parse Agent Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2260, 400],
      "parameters": {
        "functionCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞\nconst agentResponse = $json;\nconst context = $node['Prepare Agent Context'].json;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é\nlet responseText = '';\nlet intent = 'unknown';\nlet shouldUpdateStatus = false;\nlet newStatus = context.status;\n\n// –ü–∞—Ä—Å–∏–º output –∞–≥–µ–Ω—Ç–∞\nif (typeof agentResponse === 'string') {\n  responseText = agentResponse;\n} else if (agentResponse.output) {\n  responseText = agentResponse.output;\n} else if (agentResponse.text) {\n  responseText = agentResponse.text;\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º intent –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –æ—Ç–≤–µ—Ç–µ –∞–≥–µ–Ω—Ç–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞\nconst lowerResponse = responseText.toLowerCase();\nconst currentMessage = context.currentMessage?.toLowerCase() || '';\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–º–µ–Ω—É –∫–æ–Ω—Ç–∞–∫—Ç–∞\nif (currentMessage.match(/–Ω–∞–ø–∏—à[–∏|–∏—Ç–µ]?\\s+–Ω–∞|–ª—É—á—à–µ\\s+–Ω–∞|–º–æ–π\\s+(—Ç–µ–ª–µ–≥—Ä–∞–º|email|–ø–æ—á—Ç|–Ω–æ–º–µ—Ä|whatsapp|–≤–∞—Ç—Å–∞–ø)/)) {\n  intent = '—Å–º–µ–Ω–∞_–∫–æ–Ω—Ç–∞–∫—Ç–∞';\n} \n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–µ—Å\nelse if (currentMessage.includes('–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ') || currentMessage.includes('—Ä–∞—Å—Å–∫–∞–∂–∏') || currentMessage.includes('–¥–∞–≤–∞–π')) {\n  intent = '–∏–Ω—Ç–µ—Ä–µ—Å_–µ—Å—Ç—å';\n  if (context.status === 'NEW') {\n    newStatus = 'IN_PROGRESS';\n    shouldUpdateStatus = true;\n  }\n} \n// –í—Å—Ç—Ä–µ—á–∞\nelse if (lowerResponse.includes('–≤—Å—Ç—Ä–µ—á') || lowerResponse.includes('—Å–æ–∑–≤–æ–Ω')) {\n  intent = '–≥–æ—Ç–æ–≤_–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è';\n  newStatus = 'HOT';\n  shouldUpdateStatus = true;\n} \n// –¶–µ–Ω—ã\nelse if (lowerResponse.includes('—Ü–µ–Ω') || lowerResponse.includes('—Å—Ç–æ–∏–º–æ—Å—Ç') || lowerResponse.includes('—Å–∫–∏–¥–∫')) {\n  intent = '–∏–Ω—Ç–µ—Ä–µ—Å_–∫_—Ü–µ–Ω–µ';\n  if (context.status === 'NEW') {\n    newStatus = 'IN_PROGRESS';\n    shouldUpdateStatus = true;\n  }\n} \n// –¢–µ—Å—Ç\nelse if (lowerResponse.includes('—Ç–µ—Å—Ç') || lowerResponse.includes('–ø–æ–ø—Ä–æ–±–æ–≤–∞')) {\n  intent = '—Ö–æ—á–µ—Ç_—Ç–µ—Å—Ç';\n  newStatus = 'IN_PROGRESS';\n  shouldUpdateStatus = true;\n} \n// –û—Ç–∫–∞–∑\nelse if (currentMessage.includes('–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ') || currentMessage.includes('–Ω–µ –Ω–∞–¥–æ') || currentMessage.includes('—Å–ø–∞—Å–∏–±–æ, –Ω–µ—Ç')) {\n  intent = '–æ—Ç–∫–∞–∑';\n  newStatus = 'JUNK';\n  shouldUpdateStatus = true;\n} \n// –ï—Å—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫\nelse if (currentMessage.includes('—É–∂–µ –µ—Å—Ç—å') || currentMessage.includes('—Ä–∞–±–æ—Ç–∞–µ–º —Å') || currentMessage.includes('–ø–æ—Å—Ç–∞–≤—â–∏–∫')) {\n  intent = '–µ—Å—Ç—å_–ø–æ—Å—Ç–∞–≤—â–∏–∫';\n}\n// –î–æ—Ä–æ–≥–æ\nelse if (currentMessage.includes('–¥–æ—Ä–æ–≥–æ') || currentMessage.includes('–¥–µ—à–µ–≤–ª–µ') || currentMessage.includes('–±—é–¥–∂–µ—Ç')) {\n  intent = '–¥–æ—Ä–æ–≥–æ';\n}\n// –ù–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ\nelse if (currentMessage.includes('–Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ') || currentMessage.includes('–ø–æ–∫–∞ –Ω–µ') || currentMessage.includes('–º–æ–∂–µ—Ç –ø–æ–∑–∂–µ')) {\n  intent = '–Ω–µ_–∞–∫—Ç—É–∞–ª—å–Ω–æ';\n}\n\n// –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\nconst newDialogEntry = {\n  date: new Date().toISOString(),\n  from: context.isIncoming ? 'client' : 'rop',\n  message: context.isIncoming ? context.currentMessage : responseText,\n  intent: intent\n};\n\nconst updatedHistory = [...context.dialogHistory, newDialogEntry];\n\nreturn [{\n  json: {\n    context: context,\n    agentResponse: responseText,\n    intent: intent,\n    shouldUpdateStatus: shouldUpdateStatus,\n    newStatus: newStatus,\n    updatedHistory: updatedHistory,\n    shouldSendMessage: !context.isIncoming || responseText.length > 0\n  }\n}];"
      }
    },
    {
      "id": "update-crm-dialog-001",
      "name": "Update CRM Dialog History",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2460, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.update",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.context.leadId }}"
            },
            {
              "name": "fields[UF_CRM_DIALOG_HISTORY]",
              "value": "={{ JSON.stringify($json.updatedHistory) }}"
            },
            {
              "name": "fields[UF_CRM_LAST_CONTACT]",
              "value": "={{ new Date().toISOString() }}"
            },
            {
              "name": "fields[UF_CRM_CONTACT_COUNT]",
              "value": "={{ $json.updatedHistory.length }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "update-lead-status-001",
      "name": "Update Lead Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2460, 500],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.update",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.context.leadId }}"
            },
            {
              "name": "fields[STATUS_ID]",
              "value": "={{ $json.newStatus }}"
            },
            {
              "name": "fields[COMMENTS]",
              "value": "={{ $json.context.COMMENTS + '\\n\\n[' + new Date().toISOString() + '] Intent: ' + $json.intent + '\\nAgent: ' + $json.agentResponse.substring(0, 200) + '...' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "route-update-status-001",
      "name": "Should Update Status?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2460, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldUpdate",
              "leftValue": "={{ $json.shouldUpdateStatus }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "merge-crm-updates-001",
      "name": "Merge CRM Updates",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [2660, 400],
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      }
    },
    {
      "id": "route-send-message-001",
      "name": "Should Send Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2860, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldSend",
              "leftValue": "={{ $node['Parse Agent Response'].json.shouldSendMessage }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "route-channel-001",
      "name": "Route by Channel",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [3060, 300],
      "parameters": {
        "dataType": "string",
        "value1": "={{ $node['Parse Agent Response'].json.context.preferredChannel || 'telegram' }}",
        "rules": {
          "rules": [
            {
              "value2": "telegram",
              "output": 0
            },
            {
              "value2": "whatsapp",
              "output": 1
            },
            {
              "value2": "email",
              "output": 2
            }
          ]
        },
        "fallbackOutput": 0
      }
    },
    {
      "id": "send-telegram-mtproto-001",
      "name": "Send via MTProto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [3260, 200],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.MTPROTO_API_URL }}/send",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParametersJson": "={{ { \"chat_id\": $node['Parse Agent Response'].json.context.telegram || $node['Identify Message Source'].json.chatId, \"message\": $node['Parse Agent Response'].json.agentResponse, \"parse_mode\": \"Markdown\" } }}",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "MTPROTO_API_AUTH",
          "name": "MTProto API Auth"
        }
      }
    },
    {
      "id": "send-whatsapp-001",
      "name": "Send WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [3260, 300],
      "parameters": {
        "method": "POST",
        "url": "https://api.whatsapp.com/send",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppBusinessApi",
        "sendBody": true,
        "bodyParametersJson": "={{ { \"messaging_product\": \"whatsapp\", \"to\": $node['Parse Agent Response'].json.context.phone || $node['Parse Agent Response'].json.context.whatsapp, \"type\": \"text\", \"text\": { \"body\": $node['Parse Agent Response'].json.agentResponse } } }}",
        "options": {}
      },
      "credentials": {
        "whatsAppBusinessApi": {
          "id": "WHATSAPP_BUSINESS_API",
          "name": "WhatsApp Business API"
        }
      }
    },
    {
      "id": "send-email-001",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [3260, 400],
      "parameters": {
        "fromEmail": "alexander@darkproject.ru",
        "toEmail": "={{ $node['Parse Agent Response'].json.context.email }}",
        "subject": "Dark Project Arena - –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è {{ $node['Parse Agent Response'].json.context.clubName }}",
        "text": "={{ $node['Parse Agent Response'].json.agentResponse }}",
        "options": {}
      },
      "credentials": {
        "smtp": {
          "id": "SMTP_CREDENTIALS",
          "name": "SMTP Email"
        }
      }
    },
    {
      "id": "check-hot-lead-001",
      "name": "Check if Hot Lead",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3260, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "isHot",
              "leftValue": "={{ $node['Parse Agent Response'].json.newStatus }}",
              "rightValue": "HOT",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "trigger-hot-lead-handoff-001",
      "name": "Trigger Hot Lead Handoff",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [3460, 300],
      "parameters": {
        "source": "database",
        "workflowId": "={{ $env.WF_05_WORKFLOW_ID }}",
        "waitForSubWorkflow": false
      }
    },
    {
      "id": "complete-001",
      "name": "Complete",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [3460, 500],
      "parameters": {}
    },
    {
      "id": "error-trigger-001",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [260, 700],
      "parameters": {}
    },
    {
      "id": "handle-error-001",
      "name": "Handle Error",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 700],
      "parameters": {
        "functionCode": "const error = {\n  workflow: 'WF-04 Sales Nurture Agent',\n  timestamp: new Date().toISOString(),\n  error: $json.error?.message || 'Unknown error',\n  node: $json.error?.node?.name || 'Unknown',\n  context: $node['Prepare Agent Context']?.json || {}\n};\n\nconsole.error('WF-04 Agent Error:', error);\n\nreturn [{ json: error }];"
      }
    },
    {
      "id": "save-error-001",
      "name": "Save Error",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [660, 700],
      "parameters": {
        "operation": "lpush",
        "key": "errors:sales_nurture_agent",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": 86400
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      }
    },
    {
      "id": "get-new-leads-001",
      "name": "Get New Leads from CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [460, 200],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.list",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "filter[STATUS_ID]",
              "value": "NEW"
            },
            {
              "name": "filter[UF_CRM_CONTACT_COUNT]",
              "value": "0"
            },
            {
              "name": "select[]",
              "value": "ID"
            },
            {
              "name": "select[]",
              "value": "TITLE"
            },
            {
              "name": "select[]",
              "value": "PHONE"
            },
            {
              "name": "select[]",
              "value": "EMAIL"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_TELEGRAM"
            },
            {
              "name": "select[]",
              "value": "ADDRESS_CITY"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_IS_CHAIN"
            },
            {
              "name": "select[]",
              "value": "UF_CRM_ESTIMATED_PCS"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "parse-new-leads-001",
      "name": "Parse New Leads Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [560, 200],
      "parameters": {
        "functionCode": "// Parse Bitrix24 HTTP response for lead list\nconst response = $json;\n\nif (response && response.result && Array.isArray(response.result)) {\n  // Return each lead as separate item\n  return response.result.map(lead => ({ json: lead }));\n} else if (response && response.error) {\n  console.error('Bitrix24 error:', response.error);\n  return [];\n} else {\n  console.error('Invalid Bitrix24 response');\n  return [];\n}"
      }
    },
    {
      "id": "split-new-leads-001",
      "name": "Split New Leads",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [660, 200],
      "parameters": {
        "batchSize": 1,
        "options": {}
      }
    },
    {
      "id": "rate-limit-001",
      "name": "Rate Limit Protection",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [760, 200],
      "parameters": {
        "resume": "timeInterval",
        "amount": 2,
        "unit": "seconds"
      }
    },
    {
      "id": "prepare-initial-contact-001",
      "name": "Prepare Initial Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [860, 200],
      "parameters": {
        "functionCode": "// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞\nconst lead = $json;\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—É—á—à–∏–π –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏\nlet preferredChannel = 'none';\nlet contactValue = '';\n\nif (lead.UF_CRM_TELEGRAM) {\n  preferredChannel = 'telegram';\n  contactValue = lead.UF_CRM_TELEGRAM;\n} else if (lead.UF_CRM_WHATSAPP || (lead.PHONE && lead.PHONE.length > 0)) {\n  preferredChannel = 'whatsapp';\n  contactValue = lead.UF_CRM_WHATSAPP || lead.PHONE[0].VALUE || lead.PHONE;\n} else if (lead.EMAIL && lead.EMAIL.length > 0) {\n  preferredChannel = 'email';\n  contactValue = lead.EMAIL[0].VALUE || lead.EMAIL;\n}\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\nconst context = {\n  leadId: lead.ID,\n  clubName: lead.TITLE || '–£–≤–∞–∂–∞–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç',\n  city: lead.ADDRESS_CITY || '',\n  isChain: lead.UF_CRM_IS_CHAIN === 'Y',\n  estimatedPCs: parseInt(lead.UF_CRM_ESTIMATED_PCS) || 20,\n  preferredChannel: preferredChannel,\n  contactValue: contactValue,\n  isInitialContact: true,\n  needsKP: true,\n  dialogHistory: [],\n  contactCount: 0\n};\n\nif (preferredChannel === 'none') {\n  console.log(`No contact info for lead ${lead.ID}`);\n  return [{ json: { skip: true, leadId: lead.ID, reason: 'No contact info' } }];\n}\n\nreturn [{ json: context }];"
      }
    },
    {
      "id": "check-skip-lead-001",
      "name": "Check Skip Lead",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "shouldSkip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "check-working-hours-001",
      "name": "Check Working Hours",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1160, 100],
      "parameters": {
        "functionCode": "// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è\nconst now = new Date();\nconst moscowOffset = 3; // UTC+3\nconst moscowHour = (now.getUTCHours() + moscowOffset) % 24;\nconst dayOfWeek = now.getUTCDay();\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞ (1-5), 9:00-18:00 –ø–æ –ú–æ—Å–∫–≤–µ\nconst isWorkingHours = dayOfWeek >= 1 && dayOfWeek <= 5 && moscowHour >= 9 && moscowHour < 18;\n\nif (!isWorkingHours) {\n  console.log(`–ù–µ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è: –¥–µ–Ω—å ${dayOfWeek}, —á–∞—Å ${moscowHour} (–ú–°–ö)`);\n  return [{ \n    json: { \n      ...($json),\n      skipReason: 'outside_working_hours',\n      shouldWait: true,\n      moscowHour: moscowHour,\n      dayOfWeek: dayOfWeek\n    } \n  }];\n}\n\nreturn [{ json: $json }];"
      }
    },
    {
      "id": "generate-initial-kp-001",
      "name": "Generate Initial KP",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1260, 100],
      "parameters": {
        "functionCode": "// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ö–ü\nconst context = $json;\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ª–∏–¥–∞\nlet messageType = context.initialMessageType || 'soft'; // soft, direct, problem\n\n// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\nif (context.source === 'website' || context.temperature === 'hot') {\n  messageType = 'direct'; // –ü—Ä—è–º–æ–µ –ö–ü –¥–ª—è –≥–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤\n} else if (context.contactCount > 0) {\n  messageType = 'problem'; // –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\n} else {\n  messageType = 'soft'; // –ú—è–≥–∫–∏–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —Ö–æ–ª–æ–¥–Ω—ã—Ö –ª–∏–¥–æ–≤\n}\n\nlet message = '';\n\nif (messageType === 'soft') {\n  // –ú—è–≥–∫–∏–π –ø–æ–¥—Ö–æ–¥ - –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏ –≤–æ–ø—Ä–æ—Å\n  message = `–ü—Ä–∏–≤–µ—Ç! üëã\\n\\n`;\n  message += `–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, —è –∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏ Dark Project Arena.\\n`;\n  message += `–ú—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º—Å—è –Ω–∞ –∏–≥—Ä–æ–≤–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤.\\n\\n`;\n  \n  if (context.isChain) {\n    message += `–ó–∞–º–µ—Ç–∏–ª –≤–∞—à—É —Å–µ—Ç—å \"${context.clubName}\" - `;\n    message += `—Ä–∞–±–æ—Ç–∞–µ–º —Å –∫—Ä—É–ø–Ω—ã–º–∏ —Å–µ—Ç—è–º–∏ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏.\\n\\n`;\n  } else {\n    message += `–£–≤–∏–¥–µ–ª –≤–∞—à –∫–ª—É–± \"${context.clubName}\"${context.city ? ` –≤ ${context.city}` : ''}.\\n\\n`;\n  }\n  \n  message += `–£ –Ω–∞—Å –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∫–ª—É–±–æ–≤:\\n`;\n  message += `‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è\\n`;\n  message += `‚Ä¢ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è B2B\\n`;\n  message += `‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—è —Å –∑–∞–º–µ–Ω–æ–π –∑–∞ 24—á\\n\\n`;\n  \n  message += `–ê–∫—Ç—É–∞–ª—å–Ω–æ –ª–∏ –¥–ª—è –≤–∞—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è?\\n`;\n  message += `–ò–ª–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–æ–±–Ω–µ–µ –ø–æ–æ–±—â–∞—Ç—å—Å—è –ø–æ –¥—Ä—É–≥–æ–º—É –∫–æ–Ω—Ç–∞–∫—Ç—É?`;\n  \n} else if (messageType === 'problem') {\n  // –ü—Ä–æ–±–ª–µ–º–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥\n  message = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å! üëã\\n\\n`;\n  message += `–ê–ª–µ–∫—Å–∞–Ω–¥—Ä, Dark Project Arena.\\n`;\n  message += `–†–∞–±–æ—Ç–∞–µ–º —Å ${context.city ? `–∫–ª—É–±–∞–º–∏ ${context.city}` : '–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–º–∏ –∫–ª—É–±–∞–º–∏'}.\\n\\n`;\n  \n  message += `–ú–Ω–æ–≥–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—ã –∂–∞–ª—É—é—Ç—Å—è –Ω–∞:\\n`;\n  message += `‚ùå –ë—ã—Å—Ç—Ä—ã–π –∏–∑–Ω–æ—Å –º—ã—à–µ–∫ (3-4 –º–µ—Å—è—Ü–∞)\\n`;\n  message += `‚ùå –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∂–∞–ª–æ–±—ã –≥–µ–π–º–µ—Ä–æ–≤\\n`;\n  message += `‚ùå –í—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∑–∞–º–µ–Ω—É\\n\\n`;\n  \n  message += `–°—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å —Å –ø–æ–¥–æ–±–Ω—ã–º –≤ \"${context.clubName}\"?\\n\\n`;\n  message += `–£ –Ω–∞—Å –µ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–µ —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π 2 –≥–æ–¥–∞.`;\n  \n} else {\n  // –ü—Ä—è–º–æ–µ –ö–ü\n  message = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å! üéÆ\\n\\n`;\n  message += `–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è \"${context.clubName}\":\\n\\n`;\n  message += `‚úÖ –ò–≥—Ä–æ–≤—ã–µ –º—ã—à–∏ Dark Project - –æ—Ç 2500‚ÇΩ\\n`;\n  message += `‚úÖ –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã - –æ—Ç 3500‚ÇΩ\\n`;\n  message += `‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è 2 –≥–æ–¥–∞ (–∑–∞–º–µ–Ω–∞ –∑–∞ 24—á)\\n`;\n  message += `‚úÖ –°–∫–∏–¥–∫–∞ 20% –æ—Ç ${context.estimatedPCs >= 50 ? '50' : '30'} –µ–¥–∏–Ω–∏—Ü\\n\\n`;\n  \n  if (context.estimatedPCs > 30) {\n    message += `–ü—Ä–∏ –ø–∞—Ä–∫–µ –≤ ${context.estimatedPCs} –ü–ö = —ç–∫–æ–Ω–æ–º–∏—è 150 000‚ÇΩ/–≥–æ–¥\\n\\n`;\n  }\n  \n  message += `–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ? –ú–æ–≥—É –ø—Ä–∏—Å–ª–∞—Ç—å —Ä–∞—Å—á–µ—Ç.\\n\\n`;\n  message += `–ê–ª–µ–∫—Å–∞–Ω–¥—Ä, Dark Project Arena`;\n}\n\nreturn [{\n  json: {\n    ...context,\n    initialMessage: message,\n    messageType: 'initial_kp'\n  }\n}];"
      }
    },
    {
      "id": "detect-contact-change-001", 
      "name": "Detect Contact Change Request",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2060, 200],
      "parameters": {
        "functionCode": "// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Å–∏—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–∞–∫—Ç\nconst agentResponse = $json;\nconst context = $node['Prepare Agent Context'].json;\nconst currentMessage = context.currentMessage || '';\n\n// –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å–º–µ–Ω—ã –∫–æ–Ω—Ç–∞–∫—Ç–∞\nconst patterns = [\n  /–Ω–∞–ø–∏—à[–∏|–∏—Ç–µ]?\\s+–Ω–∞\\s+(\\+?[0-9\\s\\-\\(\\)]+)/i,\n  /–ª—É—á—à–µ\\s+–Ω–∞\\s+(\\+?[0-9\\s\\-\\(\\)]+)/i,\n  /–º–æ–π\\s+—Ç–µ–ª–µ–≥—Ä–∞–º\\s*[@]?([a-zA-Z0-9_]+)/i,\n  /–ø–∏—à–∏\\s+–≤\\s+—Ç–µ–ª–µ–≥—Ä–∞–º\\s*[@]?([a-zA-Z0-9_]+)/i,\n  /–Ω–∞\\s+–ø–æ—á—Ç—É\\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i,\n  /–º–æ–π\\s+email\\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i\n];\n\nlet newContactInfo = null;\nlet newContactType = null;\nlet newContactValue = null;\n\nfor (const pattern of patterns) {\n  const match = currentMessage.match(pattern);\n  if (match) {\n    newContactValue = match[1];\n    if (pattern.toString().includes('—Ç–µ–ª–µ–≥—Ä–∞–º')) {\n      newContactType = 'telegram';\n      newContactValue = newContactValue.startsWith('@') ? newContactValue : '@' + newContactValue;\n    } else if (pattern.toString().includes('email') || pattern.toString().includes('–ø–æ—á—Ç—É')) {\n      newContactType = 'email';\n    } else {\n      newContactType = 'phone';\n      newContactValue = newContactValue.replace(/[^0-9+]/g, '');\n    }\n    break;\n  }\n}\n\nif (newContactType) {\n  newContactInfo = {\n    detected: true,\n    type: newContactType,\n    value: newContactValue,\n    leadId: context.leadId\n  };\n}\n\nreturn [{\n  json: {\n    ...agentResponse,\n    newContactInfo: newContactInfo\n  }\n}];"
      }
    },
    {
      "id": "route-contact-update-001",
      "name": "Route Contact Update", 
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2260, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "hasNewContact",
              "leftValue": "={{ $json.newContactInfo?.detected }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "update-contact-in-crm-001",
      "name": "Update Contact in CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2460, 100],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BITRIX24_WEBHOOK_URL }}crm.lead.update",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $json.newContactInfo.leadId }}"
            },
            {
              "name": "fields",
              "value": "={{ JSON.stringify($json.newContactInfo.type === 'telegram' ? { UF_CRM_TELEGRAM: $json.newContactInfo.value, UF_CRM_PREFERRED_CHANNEL: 'telegram' } : $json.newContactInfo.type === 'email' ? { EMAIL: [{ VALUE: $json.newContactInfo.value, VALUE_TYPE: 'WORK' }], UF_CRM_PREFERRED_CHANNEL: 'email' } : { PHONE: [{ VALUE: $json.newContactInfo.value, VALUE_TYPE: 'WORK' }], UF_CRM_PREFERRED_CHANNEL: 'phone' }) }}"
            },
            {
              "name": "fields[COMMENTS]",
              "value": "={{ $json.context.COMMENTS + '\\n\\n[' + new Date().toISOString() + '] –ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: ' + $json.newContactInfo.type + ' - ' + $json.newContactInfo.value }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      }
    },
    {
      "id": "send-to-new-contact-001",
      "name": "Send to New Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2660, 100],
      "parameters": {
        "functionCode": "// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç\nconst data = $json;\nconst newContact = data.newContactInfo;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞\nlet confirmMessage = `–°–ø–∞—Å–∏–±–æ! –ü—Ä–æ–¥—É–±–ª–∏—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ ${newContact.value} üëç`;\nlet redirectMessage = data.agentResponse; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞\n\nreturn [{\n  json: {\n    ...data,\n    confirmMessage: confirmMessage,\n    redirectMessage: redirectMessage,\n    shouldSendToNewContact: true,\n    newChannel: newContact.type,\n    newContactValue: newContact.value\n  }\n}];"
      }
    }
  ],
  "connections": {
          "MTProto Message Trigger": {
        "main": [[{"node": "Merge Triggers", "type": "main", "index": 0}]]
      },
    "Bitrix24 Lead Update": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 1}]]
    },
    "Manual Trigger": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 2}]]
    },
    "Merge Triggers": {
      "main": [[{"node": "Identify Message Source", "type": "main", "index": 0}]]
    },
    "Identify Message Source": {
      "main": [[{"node": "Get Lead Context", "type": "main", "index": 0}]]
    },
    "Get Lead Context": {
      "main": [[{"node": "Route Lead Search", "type": "main", "index": 0}]]
    },
    "Route Lead Search": {
      "main": [
        [{"node": "Load Lead from CRM", "type": "main", "index": 0}],
        [{"node": "Search Lead by Telegram", "type": "main", "index": 0}]
      ]
    },
    "Load Lead from CRM": {
      "main": [[{"node": "Parse Load Lead Response", "type": "main", "index": 0}]]
    },
    "Parse Load Lead Response": {
      "main": [[{"node": "Merge Lead Data", "type": "main", "index": 0}]]
    },
    "Search Lead by Telegram": {
      "main": [[{"node": "Parse Search by Telegram Response", "type": "main", "index": 0}]]
    },
    "Parse Search by Telegram Response": {
      "main": [[{"node": "Merge Lead Data", "type": "main", "index": 1}]]
    },
    "Merge Lead Data": {
      "main": [[{"node": "Prepare Agent Context", "type": "main", "index": 0}]]
    },
    "Prepare Agent Context": {
      "main": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "main", "index": 0}]]
    },
    "Qdrant Knowledge Base": {
      "ai_vectorStore": [[{"node": "KB Search Tool", "type": "ai_vectorStore", "index": 0}]]
    },
    "KB Search Tool": {
      "ai_tool": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_tool", "index": 0}]]
    },
    "CRM Update Tool": {
      "ai_tool": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_tool", "index": 1}]]
    },
    "Discount Calculator": {
      "ai_tool": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_tool", "index": 2}]]
    },
    "Conversation Memory": {
      "ai_memory": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_memory", "index": 0}]]
    },
    "GPT-4 Chat Model": {
      "ai_languageModel": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_languageModel", "index": 0}]]
    },
    "GPT-3.5 Fallback Model": {
      "ai_languageModel": [[{"node": "Sales Agent –†–û–ü 20Y", "type": "ai_languageModel", "index": 1}]]
    },
    "Sales Agent –†–û–ü 20Y": {
      "main": [[{"node": "Parse Agent Response", "type": "main", "index": 0}]]
    },
    "Parse Agent Response": {
      "main": [[{"node": "Detect Contact Change Request", "type": "main", "index": 0}]]
    },
    "Update CRM Dialog History": {
      "main": [[{"node": "Should Update Status?", "type": "main", "index": 0}]]
    },
    "Should Update Status?": {
      "main": [
        [{"node": "Update Lead Status", "type": "main", "index": 0}],
        [{"node": "Merge CRM Updates", "type": "main", "index": 1}]
      ]
    },
    "Update Lead Status": {
      "main": [[{"node": "Merge CRM Updates", "type": "main", "index": 0}]]
    },
    "Merge CRM Updates": {
      "main": [[{"node": "Should Send Message?", "type": "main", "index": 0}]]
    },
          "Should Send Message?": {
        "main": [
          [{"node": "Route by Channel", "type": "main", "index": 0}],
          [{"node": "Complete", "type": "main", "index": 0}]
        ]
      },
      "Route by Channel": {
        "main": [
          [{"node": "Send via MTProto", "type": "main", "index": 0}],
          [{"node": "Send WhatsApp", "type": "main", "index": 0}],
          [{"node": "Send Email", "type": "main", "index": 0}]
        ]
      },
      "Send via MTProto": {
        "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
      },
      "Send WhatsApp": {
        "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
      },
      "Send Email": {
        "main": [[{"node": "Check if Hot Lead", "type": "main", "index": 0}]]
      },
    "Check if Hot Lead": {
      "main": [
        [{"node": "Trigger Hot Lead Handoff", "type": "main", "index": 0}],
        [{"node": "Complete", "type": "main", "index": 0}]
      ]
    },
    "Error Trigger": {
      "main": [[{"node": "Handle Error", "type": "main", "index": 0}]]
    },
    "Handle Error": {
      "main": [[{"node": "Save Error", "type": "main", "index": 0}]]
    },
    "Bitrix24 New Leads Schedule": {
      "main": [[{"node": "Get New Leads from CRM", "type": "main", "index": 0}]]
    },
    "Get New Leads from CRM": {
      "main": [[{"node": "Parse New Leads Response", "type": "main", "index": 0}]]
    },
    "Parse New Leads Response": {
      "main": [[{"node": "Split New Leads", "type": "main", "index": 0}]]
    },
    "Split New Leads": {
      "main": [[{"node": "Rate Limit Protection", "type": "main", "index": 0}]]
    },
    "Rate Limit Protection": {
      "main": [[{"node": "Prepare Initial Contact", "type": "main", "index": 0}]]
    },
    "Prepare Initial Contact": {
      "main": [[{"node": "Check Skip Lead", "type": "main", "index": 0}]]
    },
          "Check Skip Lead": {
        "main": [
          [{"node": "Check Working Hours", "type": "main", "index": 0}],
          [{"node": "Complete", "type": "main", "index": 0}]
        ]
      },
      "Check Working Hours": {
        "main": [[{"node": "Generate Initial KP", "type": "main", "index": 0}]]
      },
    "Generate Initial KP": {
      "main": [[{"node": "Route by Channel", "type": "main", "index": 0}]]
    },
    "Detect Contact Change Request": {
      "main": [[{"node": "Route Contact Update", "type": "main", "index": 0}]]
    },
    "Route Contact Update": {
      "main": [
        [{"node": "Update Contact in CRM", "type": "main", "index": 0}],
        [{"node": "Update CRM Dialog History", "type": "main", "index": 0}]
      ]
    },
    "Update Contact in CRM": {
      "main": [[{"node": "Send to New Contact", "type": "main", "index": 0}]]
    },
    "Send to New Contact": {
      "main": [[{"node": "Update CRM Dialog History", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 180,
    "timezone": "Europe/Moscow"
  },
  "version": 2,
  "id": "wf-04-sales-nurture-agent",
  "meta": {
    "templateCredsSetupCompleted": true,
    "description": "AI Agent-based sales nurturing with full dialog management, intent classification, and CRM integration",
    "version": "2.0.0"
  },
  "tags": [
    {
      "id": "1",
      "name": "production"
    },
    {
      "id": "6",
      "name": "ai-agent"
    },
    {
      "id": "7",
      "name": "sales"
    }
  ]
}