{
  "name": "WF-04 Sales Nurture",
  "nodes": [
    {
      "id": "webhook-trigger-001",
      "name": "Bitrix24 Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 400],
      "parameters": {
        "httpMethod": "POST",
        "path": "bitrix24-lead-update",
        "authentication": "headerAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "BITRIX24_WEBHOOK_SECRET",
          "name": "Bitrix24 Webhook Secret"
        }
      }
    },
    {
      "id": "manual-trigger-001",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [260, 500],
      "parameters": {}
    },
    {
      "id": "merge-triggers-001",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [460, 450],
      "parameters": {
        "mode": "chooseBranch",
        "options": {}
      }
    },
    {
      "id": "check-lead-status-001",
      "name": "Check Lead Status",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, 450],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "isNewOrInWork",
              "leftValue": "={{ $json.data?.STATUS_ID || $json.STATUS_ID }}",
              "rightValue": "NEW|IN_PROCESS",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "get-lead-details-001",
      "name": "Get Lead Details",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [860, 350],
      "parameters": {
        "resource": "lead",
        "operation": "get",
        "leadId": "={{ $json.data?.ID || $json.ID || $json.leadId }}"
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "check-last-contact-001",
      "name": "Check Last Contact Time",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1060, 350],
      "parameters": {
        "operation": "get",
        "key": "={{ `last_contact:lead:${$json.ID}` }}",
        "propertyName": "lastContact"
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "check-contact-frequency-001",
      "name": "Check Contact Frequency",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1260, 350],
      "parameters": {
        "functionCode": "const lead = $node['Get Lead Details'].json;\nconst lastContactStr = $json.lastContact;\nconst now = new Date();\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏\nlet minIntervalHours = 12; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 12 —á–∞—Å–æ–≤\n\n// –î–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ª–∏–¥–æ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É\nif (lead.UF_CRM_PRIORITY === 'high' || lead.UF_CRM_IS_CHAIN === 'Y') {\n  minIntervalHours = 6;\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç\nlet canContact = true;\nlet hoursSinceLastContact = null;\n\nif (lastContactStr) {\n  const lastContact = new Date(lastContactStr);\n  hoursSinceLastContact = (now - lastContact) / (1000 * 60 * 60);\n  canContact = hoursSinceLastContact >= minIntervalHours;\n}\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM\nconst context = {\n  leadId: lead.ID,\n  clubName: lead.TITLE || '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª—É–±',\n  contactName: lead.NAME || '–í–ª–∞–¥–µ–ª–µ—Ü',\n  phone: lead.PHONE?.[0]?.VALUE || '',\n  telegram: lead.UF_CRM_TELEGRAM || '',\n  city: lead.ADDRESS_CITY || lead.UF_CRM_CITY || '',\n  isChain: lead.UF_CRM_IS_CHAIN === 'Y',\n  branchCount: parseInt(lead.UF_CRM_BRANCH_COUNT) || 1,\n  estimatedPCs: parseInt(lead.UF_CRM_ESTIMATED_PCS) || 15,\n  priority: lead.UF_CRM_PRIORITY || 'medium',\n  leadScore: parseInt(lead.UF_CRM_LEAD_SCORE) || 0,\n  status: lead.STATUS_ID,\n  comments: lead.COMMENTS || '',\n  lastActivity: lead.DATE_MODIFY,\n  canContact,\n  hoursSinceLastContact,\n  minIntervalHours,\n  contactCount: parseInt(lead.UF_CRM_CONTACT_COUNT) || 0\n};\n\nconsole.log(`Lead ${context.leadId}: canContact=${canContact}, hoursSinceLastContact=${hoursSinceLastContact}`);\n\nreturn [{ json: { context, canContact } }];"
      }
    },
    {
      "id": "route-by-frequency-001",
      "name": "Route by Frequency",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1460, 350],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "canContact",
              "leftValue": "={{ $json.canContact }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "prepare-rag-query-001",
      "name": "Prepare RAG Query",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1660, 250],
      "parameters": {
        "functionCode": "const context = $json.context;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞\nconst query = `${context.city} –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª—É–± ${context.isChain ? '—Å–µ—Ç–µ–≤–æ–π' : ''} ${context.estimatedPCs} –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ`;\n\n// –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏\nconst metadata = {\n  type: context.isChain ? 'chain' : 'single',\n  size: context.estimatedPCs > 50 ? 'large' : context.estimatedPCs > 20 ? 'medium' : 'small'\n};\n\nconsole.log(`RAG query: ${query}`);\n\nreturn [{ \n  json: { \n    context,\n    ragQuery: query,\n    metadata\n  } \n}];"
      }
    },
    {
      "id": "qdrant-vector-search-001",
      "name": "Vector Search Qdrant",
      "type": "n8n-nodes-langchain.vectorStoreQdrant",
      "typeVersion": 1,
      "position": [1860, 250],
      "parameters": {
        "mode": "retrieve",
        "topK": 3,
        "qdrantCollection": "dark_project_kb"
      },
      "credentials": {
        "qdrantApi": {
          "id": "QDRANT_API",
          "name": "Qdrant API"
        }
      }
    },
    {
      "id": "openai-embeddings-001",
      "name": "OpenAI Embeddings",
      "type": "n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [1860, 150],
      "parameters": {
        "model": "text-embedding-3-small"
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      }
    },
    {
      "id": "prepare-llm-prompt-001",
      "name": "Prepare LLM Prompt",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2060, 250],
      "parameters": {
        "functionCode": "const context = $node['Check Contact Frequency'].json.context;\nconst vectorResults = $input.all();\n\n// –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞\nlet kbContext = '';\nif (vectorResults && vectorResults.length > 0) {\n  kbContext = vectorResults\n    .map(item => item.json.pageContent || item.json.text || '')\n    .filter(text => text.length > 0)\n    .join('\\n\\n');\n}\n\n// –ï—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã\nif (!kbContext) {\n  kbContext = `\n- –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è Dark Project Arena - –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–µ –∏–≥—Ä–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n- –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å RGB –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π\n- –ò–≥—Ä–æ–≤—ã–µ –º—ã—à–∏ —Å –≤—ã—Å–æ–∫–∏–º DPI\n- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≥–∞—Ä–Ω–∏—Ç—É—Ä—ã\n- –ì–∞—Ä–∞–Ω—Ç–∏—è 2 –≥–æ–¥–∞, –±—ã—Å—Ç—Ä–∞—è –∑–∞–º–µ–Ω–∞\n- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –∫–ª—É–±–æ–≤\n- –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç 500 000 —Ä—É–±\n  `;\n}\n\nreturn [{ \n  json: { \n    context,\n    kbContext,\n    messageType: context.contactCount === 0 ? 'initial' : 'followup'\n  } \n}];"
      }
    },
    {
      "id": "generate-message-001",
      "name": "Generate Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [2260, 250],
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "bodyParametersJson": "={{ {\n  \"model\": \"gpt-4\",\n  \"temperature\": 0.7,\n  \"max_tokens\": 500,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"–¢—ã ‚Äî –†–û–ü 20Y, –æ–ø—ã—Ç–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ Dark Project Arena –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤. –¢–µ–±–µ 35 –ª–µ—Ç, —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ 15 –ª–µ—Ç. –û–±—â–∞–µ—à—å—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–∞ '—Ç—ã', –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É. –¢–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏–µ (–¥–æ 400 —Å–∏–º–≤–æ–ª–æ–≤), –ª–∏—á–Ω—ã–µ –∏ –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤—ã–≥–æ–¥—É. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å SPIN-–ø—Ä–æ–¥–∞–∂–∏: Situation-Problem-Implication-Need. –ó–Ω–∞–µ—à—å, —á—Ç–æ –∫–ª—É–±—ã –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã –≤: –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –±—ã—Å—Ç—Ä–æ–π –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏, –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–∏ –≥–µ–π–º–µ—Ä–æ–≤, —Å–Ω–∏–∂–µ–Ω–∏–∏ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ. –¢–≤–æ—è —Ü–µ–ª—å - –≤—ã—è–≤–∏—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É –∏–ª–∏ –∑–≤–æ–Ω–æ–∫.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": `–ù–∞–ø–∏—à–∏ ${$json.messageType === 'initial' ? '–ø–µ—Ä–≤–æ–µ' : '–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ'} —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∫–ª—É–±–∞.\\n\\n–î–∞–Ω–Ω—ã–µ –∫–ª—É–±–∞:\\n- –ù–∞–∑–≤–∞–Ω–∏–µ: ${$json.context.clubName}\\n- –ì–æ—Ä–æ–¥: ${$json.context.city}\\n- –ö–æ–Ω—Ç–∞–∫—Ç: ${$json.context.contactName}\\n- –°–µ—Ç—å: ${$json.context.isChain ? '–î–∞, ' + $json.context.branchCount + ' —Ñ–∏–ª–∏–∞–ª–æ–≤' : '–ù–µ—Ç'}\\n- –ü—Ä–∏–º–µ—Ä–Ω–æ –ü–ö: ${$json.context.estimatedPCs}\\n- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${$json.context.priority}\\n- –ö–æ–Ω—Ç–∞–∫—Ç ‚Ññ${$json.context.contactCount + 1}\\n\\n–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\\n${$json.kbContext}\\n\\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\\n1. –û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ '—Ç—ã' –∫ ${$json.context.contactName || '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É'}\\n2. –£–ø–æ–º—è–Ω–∏ –≥–æ—Ä–æ–¥ ${$json.context.city}\\n3. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤—ã–≥–æ–¥–∞ —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π\\n4. ${$json.context.isChain ? '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è —Å–µ—Ç–µ–π' : '–§–æ–∫—É—Å –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å'}\\n5. –ú—è–≥–∫–∏–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)\\n6. 1-2 —ç–º–æ–¥–∑–∏\\n7. –ú–∞–∫—Å–∏–º—É–º 400 —Å–∏–º–≤–æ–ª–æ–≤\\n8. ${$json.messageType === 'followup' ? '–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π' : '–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ –†–û–ü Dark Project'}`\n    }\n  ]\n} }}",
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_API",
          "name": "OpenAI API"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "parse-message-001",
      "name": "Parse Message",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2460, 250],
      "parameters": {
        "functionCode": "const context = $node['Check Contact Frequency'].json.context;\nconst openAiResponse = $json;\n\nlet message = '';\nlet error = null;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ OpenAI\nif (openAiResponse.statusCode === 200 && openAiResponse.body?.choices?.[0]?.message?.content) {\n  message = openAiResponse.body.choices[0].message.content.trim();\n} else {\n  error = openAiResponse.error || 'Failed to generate message';\n  // Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ\n  message = `–ü—Ä–∏–≤–µ—Ç! üëã –Ø –∏–∑ Dark Project Arena. –ó–∞–º–µ—Ç–∏–ª —Ç–≤–æ–π –∫–ª—É–± –≤ ${context.city}. –£ –Ω–∞—Å –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∏–≥—Ä–æ–≤–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏${context.isChain ? ' —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –¥–ª—è —Å–µ—Ç–µ–π' : ''}. –ú–æ–∂–µ–º –æ–±—Å—É–¥–∏—Ç—å?`;\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è\nif (message.length > 400) {\n  message = message.substring(0, 397) + '...';\n}\n\nconst output = {\n  context,\n  message,\n  generatedAt: new Date().toISOString(),\n  error\n};\n\nconsole.log(`Generated message for ${context.clubName}: ${message.length} chars`);\n\nreturn [{ json: output }];"
      }
    },
    {
      "id": "send-telegram-001",
      "name": "Send Telegram Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2660, 250],
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $json.context.telegram }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML",
          "disable_notification": false,
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å",
                  "callback_data": "={{ `call_me_${$json.context.leadId}` }}"
                },
                {
                  "text": "üìÖ –í—Å—Ç—Ä–µ—á–∞",
                  "callback_data": "={{ `meeting_${$json.context.leadId}` }}"
                }
              ],
              [
                {
                  "text": "üìÑ –ü—Ä–∞–π—Å",
                  "callback_data": "={{ `price_${$json.context.leadId}` }}"
                },
                {
                  "text": "‚ùå –ù–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ",
                  "callback_data": "={{ `not_interested_${$json.context.leadId}` }}"
                }
              ]
            ]
          }
        }
      },
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_BOT",
          "name": "Telegram Bot"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "update-last-contact-001",
      "name": "Update Last Contact",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [2860, 250],
      "parameters": {
        "operation": "set",
        "key": "={{ `last_contact:lead:${$json.context.leadId}` }}",
        "value": "={{ new Date().toISOString() }}",
        "expire": true,
        "ttl": 2592000
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      }
    },
    {
      "id": "update-lead-001",
      "name": "Update Lead",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [3060, 250],
      "parameters": {
        "resource": "lead",
        "operation": "update",
        "leadId": "={{ $json.context.leadId }}",
        "updateFields": {
          "UF_CRM_CONTACT_COUNT": "={{ ($json.context.contactCount || 0) + 1 }}",
          "UF_CRM_LAST_CONTACT": "={{ new Date().toISOString() }}",
          "COMMENTS": "={{ $json.context.comments + '\\n\\n[' + new Date().toISOString() + '] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Ññ' + (($json.context.contactCount || 0) + 1) + ' —á–µ—Ä–µ–∑ ' + ($json.context.telegram ? 'Telegram' : 'Email') }}"
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "log-activity-001",
      "name": "Log Activity",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [3260, 250],
      "parameters": {
        "operation": "set",
        "key": "={{ `sales_activity:${$json.context.leadId}:${Date.now()}` }}",
        "value": "={{ JSON.stringify({ ...$json, activityType: $json.message ? 'message_sent' : 'task_created' }) }}",
        "expire": true,
        "ttl": 7776000
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      }
    },
    {
      "id": "check-telegram-001",
      "name": "Has Telegram?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2460, 200],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "hasTelegram",
              "leftValue": "={{ $json.context.telegram }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "create-task-fallback-001",
      "name": "Create CRM Task (No Telegram)",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [2660, 150],
      "parameters": {
        "resource": "task",
        "operation": "create",
        "title": "={{ `–°–≤—è–∑–∞—Ç—å—Å—è —Å ${$json.context.contactName || '–∫–ª–∏–µ–Ω—Ç–æ–º'} (${ $json.context.clubName })` }}",
        "description": "={{ `–ù–µ—Ç Telegram –≤ –ª–∏–¥–µ. –°–≤—è–∑–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É ${$json.context.phone || '-'} –∏–ª–∏ email. –õ–∏–¥ ID: ${$json.context.leadId}` }}",
        "additionalFields": {
          "deadline": "={{ new Date(Date.now() + 24*60*60*1000).toISOString() }}",
          "responsible_id": "={{ $env.ACCOUNT_MANAGER_ID }}",
          "crm": {
            "lead": ["={{ $json.context.leadId }}"]
          },
          "tags": ["nurture", "no-telegram"]
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "update-lead-fallback-001",
      "name": "Update Lead (Fallback)",
      "type": "n8n-nodes-base.bitrix24",
      "typeVersion": 1,
      "position": [2860, 150],
      "parameters": {
        "resource": "lead",
        "operation": "update",
        "leadId": "={{ $json.context.leadId }}",
        "updateFields": {
          "COMMENTS": "={{ ($json.context.comments || '') + '\n\n[' + new Date().toISOString() + '] –°–æ–∑–¥–∞–Ω–∞ –∑–∞–¥–∞—á–∞ –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç (–Ω–µ—Ç Telegram)' }}"
        }
      },
      "credentials": {
        "bitrix24Api": {
          "id": "BITRIX24_CRM",
          "name": "Bitrix24 CRM"
        }
      }
    },
    {
      "id": "too-soon-handler-001",
      "name": "Too Soon Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1660, 450],
      "parameters": {
        "functionCode": "const context = $json.context;\n\nconst output = {\n  success: false,\n  reason: 'too_soon',\n  leadId: context.leadId,\n  clubName: context.clubName,\n  hoursSinceLastContact: context.hoursSinceLastContact,\n  minIntervalHours: context.minIntervalHours,\n  nextContactTime: new Date(Date.now() + (context.minIntervalHours - context.hoursSinceLastContact) * 60 * 60 * 1000).toISOString()\n};\n\nconsole.log(`Skipping contact for ${context.clubName}: too soon (${context.hoursSinceLastContact}h < ${context.minIntervalHours}h)`);\n\nreturn [{ json: output }];"
      }
    },
    {
      "id": "complete-001",
      "name": "Complete",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [3460, 350],
      "parameters": {
        "mode": "combine",
        "combinationMode": "chooseBranch",
        "options": {}
      }
    },
    {
      "id": "error-trigger-001",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [260, 700],
      "parameters": {}
    },
    {
      "id": "handle-error-001",
      "name": "Handle Error",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 700],
      "parameters": {
        "functionCode": "const error = {\n  workflow: 'WF-04 Sales Nurture',\n  timestamp: new Date().toISOString(),\n  error: $json.error?.message || 'Unknown error',\n  node: $json.error?.node?.name || 'Unknown',\n  leadId: $node['Check Contact Frequency']?.json?.context?.leadId || 'Unknown'\n};\n\nconsole.error('WF-04 Error:', error);\n\nreturn [{ json: error }];"
      }
    },
    {
      "id": "save-error-001",
      "name": "Save Error",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [660, 700],
      "parameters": {
        "operation": "lpush",
        "key": "errors:sales_nurture",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": 86400
      },
      "credentials": {
        "redis": {
          "id": "REDIS_INTERNAL",
          "name": "Redis Internal"
        }
      }
    },
    {
      "id": "retry-if-openai-001",
      "name": "Generate Message (Retry IF)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2460, 200],
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "is429", "leftValue": "={{ $node['Generate Message'].json.statusCode }}", "rightValue": 429, "operator": {"type": "number", "operation": "equals"}},
            {"id": "is5xx", "leftValue": "={{ $node['Generate Message'].json.statusCode }}", "rightValue": "^5\\d{2}$", "operator": {"type": "string", "operation": "regex"}}
          ],
          "combinator": "or"
        },
        "options": {}
      }
    },
    {
      "id": "wait-openai-retry-001",
      "name": "Wait OpenAI Retry",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [2660, 200],
      "parameters": {"amount": 5, "unit": "seconds"}
    }
  ],
  "connections": {
    "Bitrix24 Webhook": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 0}]]
    },
    "Manual Trigger": {
      "main": [[{"node": "Merge Triggers", "type": "main", "index": 1}]]
    },
    "Merge Triggers": {
      "main": [[{"node": "Check Lead Status", "type": "main", "index": 0}]]
    },
    "Check Lead Status": {
      "main": [
        [{"node": "Get Lead Details", "type": "main", "index": 0}],
        []
      ]
    },
    "Get Lead Details": {
      "main": [[{"node": "Check Last Contact Time", "type": "main", "index": 0}]]
    },
    "Check Last Contact Time": {
      "main": [[{"node": "Check Contact Frequency", "type": "main", "index": 0}]]
    },
    "Check Contact Frequency": {
      "main": [[{"node": "Route by Frequency", "type": "main", "index": 0}]]
    },
    "Route by Frequency": {
      "main": [
        [{"node": "Prepare RAG Query", "type": "main", "index": 0}],
        [{"node": "Too Soon Handler", "type": "main", "index": 0}]
      ]
    },
    "Prepare RAG Query": {
      "main": [[{"node": "Vector Search Qdrant", "type": "main", "index": 0}]]
    },
    "Vector Search Qdrant": {
      "ai_embedding": [[{"node": "OpenAI Embeddings", "type": "ai_embedding", "index": 0}]],
      "main": [[{"node": "Prepare LLM Prompt", "type": "main", "index": 0}]]
    },
    "Prepare LLM Prompt": {
      "main": [[{"node": "Generate Message", "type": "main", "index": 0}]]
    },
    "Generate Message": {
      "main": [[{"node": "Parse Message", "type": "main", "index": 0}]]
    },
    "Generate Message (Retry IF)": {
      "main": [
        [{"node": "Wait OpenAI Retry", "type": "main", "index": 0}],
        [{"node": "Parse Message", "type": "main", "index": 0}]
      ]
    },
    "Wait OpenAI Retry": {
      "main": [[{"node": "Generate Message", "type": "main", "index": 0}]]
    },
    "Parse Message": {
      "main": [[{"node": "Has Telegram?", "type": "main", "index": 0}]]
    },
    "Has Telegram?": {
      "main": [
        [{"node": "Send Telegram Message", "type": "main", "index": 0}],
        [{"node": "Create CRM Task (No Telegram)", "type": "main", "index": 0}]
      ]
    },
    "Create CRM Task (No Telegram)": {
      "main": [[{"node": "Update Lead (Fallback)", "type": "main", "index": 0}]]
    },
    "Update Lead (Fallback)": {
      "main": [[{"node": "Log Activity", "type": "main", "index": 0}]]
    },
    "Send Telegram Message": {
      "main": [[{"node": "Update Last Contact", "type": "main", "index": 0}]]
    },
    "Update Last Contact": {
      "main": [[{"node": "Update Lead", "type": "main", "index": 0}]]
    },
    "Update Lead": {
      "main": [[{"node": "Log Activity", "type": "main", "index": 0}]]
    },
    "Log Activity": {
      "main": [[{"node": "Complete", "type": "main", "index": 0}]]
    },
    "Too Soon Handler": {
      "main": [[{"node": "Complete", "type": "main", "index": 1}]]
    },
    "Error Trigger": {
      "main": [[{"node": "Handle Error", "type": "main", "index": 0}]]
    },
    "Handle Error": {
      "main": [[{"node": "Save Error", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 120,
    "timezone": "Europe/Moscow"
  },
  "version": 2,
  "id": "wf-04-sales-nurture",
  "meta": {
    "templateCredsSetupCompleted": true,
    "description": "Sales nurturing with RAG using Qdrant vector store, GPT-4 personalization, and contact frequency control",
    "version": "1.0.0"
  },
  "tags": [
    {
      "id": "1",
      "name": "production"
    },
    {
      "id": "6",
      "name": "sales"
    },
    {
      "id": "8",
      "name": "ai"
    }
  ]
}